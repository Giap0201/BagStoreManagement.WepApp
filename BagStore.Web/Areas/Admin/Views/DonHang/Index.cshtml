@{
    ViewData["Title"] = "Danh sách đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<!-- ✅ DataTables Bootstrap 5 (phù hợp với Purple Admin, SB Admin, v.v.) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" />

<style>
    body {
        background-color: #fff !important;
    }

    .content-wrapper,
    .main-panel {
        background-color: #fff !important;
    }
</style>


<h2 class="mb-4">
    <i class="mdi mdi-package-variant-closed text-info me-2"></i>
    Danh sách đơn hàng
</h2>

<div class="table-responsive">
<table id="adminOrders" class="table table-bordered table-striped align-middle text-nowrap" style="width:100%">
    <thead>
        <tr>
            <th>Mã</th>
            <th>Khách hàng</th>
            <th>Ngày đặt</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
    </thead>
</table>
</div>

@section Scripts {
    <!-- ✅ DataTables + Bootstrap 5 integration -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>


    <script>
        $(function () {
            var table = $('#adminOrders').DataTable({
                responsive: true,
                autoWidth: false,
                ajax: {
                    url: '/api/DonHangApi', // ensure API supports GET all
                    xhrFields: { withCredentials: true }, // nếu cần gửi cookie
                    dataSrc: '',
                },
                columns: [
                    { data: 'maDonHang' },
                    { data: 'tenKhachHang' },
                    { data: 'ngayDatHang', render: d => new Date(d).toLocaleString() },
                    { data: 'tongTien', render: d => d.toLocaleString() },
                    { data: 'trangThai' },
                    {
                        data: null,
                        orderable: false,
                        render: function (row) {
                            // render dropdown with current status selected
                            const statuses = ['Chờ xử lý', 'Đang giao hàng', 'Hoàn thành', 'Đã huỷ'];
                            let options = statuses.map(s => `<option value="${s}" ${s === row.trangThai ? 'selected' : ''}>${s}</option>`).join('');
                            return `<select onchange="updateStatus(${row.maDonHang}, this.value)">${options}</select>`;
                        }
                    }
                ],
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.5/i18n/vi.json",
                    info: "Đang hiển thị _START_–_END_ trên tổng số _TOTAL_ đơn hàng"
                }
            });

            // Expose reload function
            window.reloadOrders = function() {
                table.ajax.reload(null, false);
            };
        });

            async function updateStatus(maDonHang, trangThai) {
            const confirmRes = await Swal.fire({
                title: 'Xác nhận',
                text: `Bạn muốn đổi trạng thái sang "${trangThai}"?`,
                icon: 'question',
                showCancelButton: true
            });
            if (!confirmRes.isConfirmed) {
                // optional: reload table to revert selection if cancelled
                window.reloadOrders();
                return;
            }

            try {
                const res = await fetch('/api/DonHangApi/capnhat-trangthai', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaDonHang: maDonHang, TrangThai: trangThai })
                });

                if (res.ok) {
                    const data = await res.json();
                    await Swal.fire('Thành công', 'Cập nhật trạng thái thành công', 'success');
                    window.reloadOrders();
                } else {
                    const txt = await res.text();
                    await Swal.fire('Lỗi', txt, 'error');
                    window.reloadOrders();
                }
            } catch (err) {
                await Swal.fire('Lỗi', err.message || 'Lỗi mạng', 'error');
                window.reloadOrders();
            }
        }
    </script>
}
