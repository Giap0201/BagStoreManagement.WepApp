@{
    ViewData["Title"] = "Quản lý chất liệu";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="card shadow-sm border-0 mt-4">
    <!-- Header -->
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-texture text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Quản lý chất liệu</h4>
    </div>

    <div class="card-body pt-3">
        <!-- Thanh tìm kiếm -->
        <div class="row g-2 align-items-center mb-3">
            <div class="col-md-8">
                <input type="text" id="txtSearchChatLieu" class="form-control" placeholder="🔍 Nhập từ khóa để tìm kiếm ...">
            </div>
            <div class="col-md-4 text-md-start text-end">
                <button id="btnSearchChatLieu" class="btn btn-outline-primary">
                    <i class="mdi mdi-magnify me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="table-responsive">
            <table id="tblChatLieu" class="table table-striped table-hover align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Mã chất liệu</th>
                        <th scope="col">Tên chất liệu</th>
                        <th scope="col">Mô tả</th>
                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody id="tblChatLieuBody">
                </tbody>
            </table>
        </div>

        <!-- Nút thêm mới -->
        <div class="text-end mt-4">
            <button id="btnAddChatLieu" class="btn btn-primary px-4">
                <i class="mdi mdi-plus-circle-outline me-1"></i> + Thêm chất liệu
            </button>
        </div>
    </div>

    <!-- Modal thêm/sửa -->
    <div class="modal fade" id="chatLieuModal" tabindex="-1" aria-labelledby="chatLieuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="chatLieuModalLabel">Thêm mới chất liệu</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="chatLieuForm">
                        <input type="hidden" id="chatLieuId" name="MaChatLieu" />

                        <div class="mb-3">
                            <label for="tenChatLieu" class="form-label">Tên chất liệu</label>
                            <input type="text" class="form-control" id="tenChatLieu" name="TenChatLieu" required>
                        </div>

                        <div class="mb-3">
                            <label for="moTaChatLieu" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="moTaChatLieu" name="MoTa" rows="3"></textarea>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="chatLieuForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // === 1. Khai báo URL API ===
            var apiUrl = '/api/ChatLieuApi';

            // === 2. Hàm tải dữ liệu lên bảng ===
            function loadChatLieu() {
                $("#tblChatLieuBody").html("<tr><td colspan='4'>Đang tải dữ liệu...</td></tr>");

                $.ajax({
                    url: apiUrl,
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        var rows = "";

                        if (data.length === 0) {
                            rows = "<tr><td colspan='4'>Không có dữ liệu</td></tr>";
                        } else {
                            $.each(data, function (i, item) {
                                rows += "<tr>" +
                                    "<td>" + item.maChatLieu + "</td>" +
                                    "<td>" + item.tenChatLieu + "</td>" +
                                    "<td>" + (item.moTa || '') + "</td>" +
                                    "<td>" +
                                        "<button class='btn btn-warning btn-sm btnEdit' data-id='" + item.maChatLieu + "'>Sửa</button> " +
                                        "<button class='btn btn-danger btn-sm btnDelete' data-id='" + item.maChatLieu + "'>Xóa</button>" +
                                    "</td>" +
                                "</tr>";
                            });
                        }

                        $("#tblChatLieuBody").html(rows);
                    },
                    error: function () {
                        alert("Lỗi khi tải dữ liệu!");
                    }
                });
            }

            // Gọi khi trang vừa load
            loadChatLieu();


            // === 3. Khi nhấn nút "Thêm chất liệu" ===
            $("#btnAddChatLieu").click(function () {
                $("#chatLieuId").val(0);
                $("#tenChatLieu").val("");
                $("#moTaChatLieu").val("");
                $("#chatLieuModalLabel").text("Thêm chất liệu mới");
                $("#chatLieuModal").modal("show");
            });


            // === 4. Khi nhấn nút "Lưu thay đổi" (trong form) ===
            $("#chatLieuForm").submit(function (e) {
                e.preventDefault();

                var id = $("#chatLieuId").val();
                var data = {
                    MaChatLieu: id,
                    TenChatLieu: $("#tenChatLieu").val(),
                    MoTa: $("#moTaChatLieu").val()
                };

                var method = id == 0 ? "POST" : "PUT";
                var url = id == 0 ? apiUrl : apiUrl + "/" + id;

                $.ajax({
                    url: url,
                    type: method,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function () {
                        alert("Lưu thành công!");
                        $("#chatLieuModal").modal("hide");
                        loadChatLieu();
                    },
                    error: function () {
                        alert("Có lỗi xảy ra khi lưu!");
                    }
                });
            });


            // === 5. Khi nhấn nút "Sửa" ===
            $(document).on("click", ".btnEdit", function () {
                var id = $(this).data("id");

                $.ajax({
                    url: apiUrl + "/" + id,
                    type: "GET",
                    dataType: "json",
                    success: function (item) {
                        $("#chatLieuId").val(item.maChatLieu);
                        $("#tenChatLieu").val(item.tenChatLieu);
                        $("#moTaChatLieu").val(item.moTa);
                        $("#chatLieuModalLabel").text("Chỉnh sửa chất liệu");
                        $("#chatLieuModal").modal("show");
                    },
                    error: function () {
                        alert("Không lấy được dữ liệu chất liệu!");
                    }
                });
            });


            // === 6. Khi nhấn nút "Xóa" ===
            $(document).on("click", ".btnDelete", function () {
                if (!confirm("Bạn có chắc chắn muốn xóa chất liệu này không?")) return;

                var id = $(this).data("id");

                $.ajax({
                    url: apiUrl + "/" + id,
                    type: "DELETE",
                    success: function () {
                        alert("Đã xóa thành công!");
                        loadChatLieu();
                    },
                    error: function () {
                        alert("Lỗi khi xóa chất liệu!");
                    }
                });
            });


            // === 7. Chức năng tìm kiếm đơn giản ===
            $("#btnSearchChatLieu").click(function () {
                var keyword = $("#txtSearchChatLieu").val().toLowerCase();

                $("#tblChatLieuBody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(keyword) > -1);
                });
            });

        });
    </script>
}
