@{
    ViewData["Title"] = "Quản lý chất liệu";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="card shadow-sm border-0 mt-4">
    <!-- Header -->
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-table text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Quản lý chất liệu</h4>
    </div>

    <div class="card-body pt-3">
        <!-- Thanh tìm kiếm -->
        <div class="row g-2 align-items-center mb-3">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên chất liệu để tìm kiếm...">
            </div>
            <div class="col-md-4 text-md-start text-end">
                <button id="btnSearch" class="btn btn-outline-primary">
                    <i class="mdi mdi-magnify me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Mã chất liệu</th>
                        <th scope="col">Tên chất liệu</th>
                        <th scope="col">Mô tả</th>
                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dữ liệu sẽ được load bằng JS -->
                </tbody>
            </table>
        </div>

        <!-- Nút thêm dữ liệu -->
        <div class="text-end mt-4">
            <button id="btnAddNew" class="btn btn-primary px-4">
                <i class="mdi mdi-plus-circle-outline me-1"></i> +Thêm chất liệu
            </button>
        </div>
    </div>

    <!-- Modal Thêm/Sửa chung -->
    <div class="modal fade" id="modalData" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Thêm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="modalForm">
                        <input type="hidden" id="inputId" name="Id" />
                        <div class="mb-3">
                            <label for="inputName" class="form-label">Tên chất liệu</label>
                            <input type="text" class="form-control" id="inputName" name="Name" required>
                            <div class="invalid-feedback">Vui lòng nhập tên chất liệu (tối thiểu 3 ký tự).</div>
                        </div>
                        <div class="mb-3">
                            <label for="inputDesc" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="inputDesc" name="Desc" rows="3" required></textarea>
                            <div class="invalid-feedback">Vui lòng nhập mô tả chất liệu.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="modalForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // === 1. CÁC THÔNG TIN CẦN THIẾT BAN ĐẦU ===
            const apiUrl = '/api/ChatLieuApi';
            const tableBody = $('#tableBody');
            const modalDataInstance = new bootstrap.Modal(document.getElementById('modalData'));
            const modalLabel = $('#modalLabel');
            const modalForm = $('#modalForm');
            const inputName = $('#inputName');
            const inputDesc = $('#inputDesc');
            let allMaterials = [];

            // === 2. HÀM RENDER BẢNG DỮ LIỆU ===
            function renderTable(materialsToRender) {
                tableBody.empty();

                if (materialsToRender.length === 0) {
                    tableBody.html('<tr><td colspan="4" class="text-center text-info">Không có chất liệu nào.</td></tr>');
                    return;
                }

                $.each(materialsToRender, function (index, item) {
                    const row = `
                        <tr>
                            <td>${item.maChatLieu}</td>
                            <td>${item.tenChatLieu}</td>
                            <td>${item.moTa || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning me-1 btn-edit" data-id="${item.maChatLieu}">
                                    Sửa
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${item.maChatLieu}">
                                    Xóa
                                </button>
                            </td>
                        </tr>`;
                    tableBody.append(row);
                });
            }

            // === 3. HÀM CHÍNH: LẤY DỮ LIỆU TỪ SERVER ===
            function loadData() {
                tableBody.html('<tr><td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td></tr>');

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            allMaterials = response.data;
                            renderTable(allMaterials);
                        } else {
                            Swal.fire('Lỗi!', response.message, 'error');
                            tableBody.html('<tr class="table-danger"><td colspan="4" class="text-center">Lỗi khi tải dữ liệu.</td></tr>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi tải dữ liệu:', error);
                        Swal.fire('Lỗi!', 'Không thể tải dữ liệu chất liệu.', 'error');
                    }
                });
            }

            // Gọi loadData khi trang tải
            loadData();

            // === 4. KHI NHẤN NÚT "THÊM CHẤT LIỆU" ===
            $('#btnAddNew').on('click', function () {
                modalForm[0].reset();
                inputName.removeClass('is-invalid');
                inputDesc.removeClass('is-invalid');
                $('#inputId').val(0);
                modalLabel.text('Thêm mới chất liệu');
                modalDataInstance.show();
            });

            // === 5. KHI NHẤN NÚT "SỬA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-edit', function () {
                const id = $(this).data('id');

                $.ajax({
                    url: `${apiUrl}/${id}`,
                    method: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            const item = response.data;
                            $('#inputId').val(item.maChatLieu);
                            $('#inputName').val(item.tenChatLieu).removeClass('is-invalid');
                            $('#inputDesc').val(item.moTa).removeClass('is-invalid');
                            modalLabel.text('Cập nhật chất liệu');
                            modalDataInstance.show();
                        } else {
                            Swal.fire('Lỗi!', response.message, 'error');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(`Lỗi khi lấy chất liệu ${id}:`, error);
                        Swal.fire('Lỗi!', 'Không tìm thấy chất liệu này.', 'error');
                    }
                });
            });

            // === 6. KHI NHẤN NÚT "XÓA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-delete', function () {
                const id = $(this).data('id');

                Swal.fire({
                    title: 'Bạn có chắc chắn xóa không?',
                    text: 'Dữ liệu này sẽ bị xóa vĩnh viễn!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận xóa',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            method: 'DELETE',
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire('Đã xóa!', response.message, 'success');
                                    loadData();
                                } else {
                                    Swal.fire('Lỗi!', response.message, 'error');
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error(`Lỗi khi xóa chất liệu ${id}:`, error);
                                Swal.fire('Lỗi!', 'Không xóa được chất liệu, có thể chất liệu đang được sử dụng.', 'error');
                            }
                        });
                    }
                });
            });

            // === 7. KHI NHẤN NÚT "LƯU THAY ĐỔI" TRONG MODAL ===
            modalForm.on('submit', function (e) {
                e.preventDefault();

                // Client-side validation
                const tenChatLieu = inputName.val().trim();
                const moTa = inputDesc.val().trim();
                let isValid = true;

                if (tenChatLieu.length < 3) {
                    inputName.addClass('is-invalid');
                    isValid = false;
                } else {
                    inputName.removeClass('is-invalid');
                }

                if (moTa === '') {
                    inputDesc.addClass('is-invalid');
                    isValid = false;
                } else {
                    inputDesc.removeClass('is-invalid');
                }

                if (!isValid) {
                    return;
                }

                const id = $('#inputId').val();
                const dataToSend = {
                    maChatLieu: id,
                    tenChatLieu: tenChatLieu,
                    moTa: moTa
                };

                const isNew = (id === '0' || id === 0 || id === null || id === '');
                const method = isNew ? 'POST' : 'PUT';
                const url = isNew ? apiUrl : `${apiUrl}/${id}`;

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(dataToSend),
                    success: function (response) {
                        if (response.success) {
                            modalDataInstance.hide();
                            Swal.fire('Thành công!', response.message, 'success');
                            loadData();
                        } else {
                            let errorMsg = response.message;
                            if (response.errors && response.errors.length > 0) {
                                errorMsg += '<ul>' + response.errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                            }
                            Swal.fire({
                                title: 'Lỗi!',
                                html: errorMsg,
                                icon: 'error'
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi lưu chất liệu:', error);
                        Swal.fire('Lỗi!', 'Có lỗi xảy ra khi lưu chất liệu.', 'error');
                    }
                });
            });

            // === 8. CHỨC NĂNG TÌM KIẾM THEO TÊN (CLIENT-SIDE) ===
            $('#searchInput').on('keyup', function () {
                const searchTerm = $(this).val().toLowerCase().trim();

                if (searchTerm === '') {
                    renderTable(allMaterials);
                    return;
                }

                const filteredMaterials = allMaterials.filter(item =>
                    item.tenChatLieu.toLowerCase().includes(searchTerm)
                );

                renderTable(filteredMaterials);
            });

            // Khi click nút Tìm kiếm, kích hoạt sự kiện keyup
            $('#btnSearch').on('click', function () {
                $('#searchInput').trigger('keyup');
            });
        });
    </script>
}