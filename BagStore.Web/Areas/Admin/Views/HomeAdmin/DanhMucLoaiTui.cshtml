@{
    ViewData["Title"] = "Quản lý danh mục loại túi";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="card shadow-sm border-0 mt-4">
    <!-- Header -->
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-table text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Quản lý danh mục</h4>
    </div>

    <div class="card-body pt-3">
        <!-- Thanh tìm kiếm -->
        <div class="row g-2 align-items-center mb-3">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên danh mục để tìm kiếm...">
            </div>
            <div class="col-md-4 text-md-start text-end">
                <button id="btnSearch" class="btn btn-outline-primary">
                    <i class="mdi mdi-magnify me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Mã danh mục</th>
                        <th scope="col">Tên danh mục</th>
                        <th scope="col">Mô tả</th>
                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dữ liệu sẽ được load bằng JS -->
                </tbody>
            </table>
        </div>

        <!-- Nút thêm dữ liệu -->
        <div class="text-end mt-4">
            <button id="btnAddNew" class="btn btn-primary px-4">
                <i class="mdi mdi-plus-circle-outline me-1"></i> +Thêm danh mục
            </button>
        </div>
    </div>

    <!-- Modal Thêm/Sửa chung -->
    <div class="modal fade" id="modalData" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Thêm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="modalForm">
                        <input type="hidden" id="inputId" name="Id" />

                        <div class="mb-3">
                            <label for="inputName" class="form-label">Tên danh mục</label>
                            <input type="text" class="form-control" id="inputName" name="Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="inputDesc" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="inputDesc" name="Desc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="modalForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // === 1. CÁC THÔNG TIN CẦN THIẾT BAN ĐẦU ===
            // Địa chỉ của API trên server của bạn (nơi xử lý dữ liệu)
            const apiUrl = '/api/DanhMucLoaiTuiApi';

            // Các phần tử HTML mà chúng ta sẽ tương tác:
            const tableBody = $('#tableBody');          // Cái bảng nơi hiển thị danh sách
            // Khởi tạo Bootstrap Modal MỘT LẦN ở đây
            const modalDataInstance = new bootstrap.Modal(document.getElementById('modalData'));
            const modalLabel = $('#modalLabel');        // Tiêu đề của hộp thoại popup
            const modalForm = $('#modalForm');              // Cái form trong hộp thoại popup

            // --- Biến để lưu trữ toàn bộ dữ liệu danh mục để phục vụ tìm kiếm cục bộ ---
            let allCategories = [];

            // === 2. HÀM CHÍNH: LẤY DỮ LIỆU TỪ SERVER VÀ HIỂN THỊ LÊN BẢNG ===
            function loadData() {
                tableBody.html('<tr><td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td></tr>');

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        allCategories = data; // Lưu dữ liệu đã tải vào biến toàn cục
                        renderTable(allCategories); // Hiển thị tất cả dữ liệu ban đầu
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi tải dữ liệu:", error);
                        tableBody.html('<tr class="table-danger"><td colspan="4" class="text-center">Lỗi khi tải dữ liệu.</td></tr>');
                        Swal.fire('Lỗi!', 'Không thể tải dữ liệu danh mục.', 'error');
                    }
                });
            }

            // Hàm riêng để render (vẽ) bảng từ một mảng dữ liệu
            function renderTable(categoriesToRender) {
                tableBody.empty();

                if (categoriesToRender.length === 0) {
                    tableBody.html('<tr><td colspan="4" class="text-center text-info">Không có danh mục nào.</td></tr>');
                    return;
                }

                $.each(categoriesToRender, function (index, item) {
                    const row = `
                        <tr>
                            <td>${item.maLoaiTui}</td>
                            <td>${item.tenLoaiTui}</td>
                            <td>${item.moTa || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning me-1 btn-edit" data-id="${item.maLoaiTui}">
                                    Sửa
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${item.maLoaiTui}">
                                    Xóa
                                </button>
                            </td>
                        </tr>`;
                    tableBody.append(row);
                });
            }

            // Gọi hàm này NGAY KHI TRANG TẢI XONG để hiển thị danh sách ban đầu
            loadData();

            // === 3. KHI NHẤN NÚT "THÊM DANH MỤC" ===
            $('#btnAddNew').on('click', function () {
                modalForm[0].reset(); // Xóa trắng các ô nhập trong form
                $('#inputId').val(0); // Đặt ID là 0 để biết đây là THÊM MỚI (server sẽ tự tạo ID)
                modalLabel.text('Thêm mới danh mục'); // Đổi tiêu đề hộp thoại
                modalDataInstance.show(); 
            });

            // === 4. KHI NHẤN NÚT "SỬA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-edit', function () {
                const id = $(this).data('id');

                $.ajax({
                    url: `${apiUrl}/${id}`,
                    method: 'GET',
                    dataType: 'json',
                    success: function (item) {
                        $('#inputId').val(item.maLoaiTui);
                        $('#inputName').val(item.tenLoaiTui);
                        $('#inputDesc').val(item.moTa);

                        modalLabel.text('Cập nhật danh mục');
                        modalDataInstance.show(); // Dùng modalDataInstance để mở modal
                    },
                    error: function (xhr, status, error) {
                        console.error(`Lỗi khi lấy danh mục ${id}:`, error);
                        Swal.fire('Lỗi!', 'Không tìm thấy danh mục này.', 'error');
                    }
                });
            });

            // === 5. KHI NHẤN NÚT "XÓA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-delete', function () {
                const id = $(this).data('id');

                Swal.fire({
                    title: 'Bạn có chắc chắn xoá không?',
                    text: "Dữ liệu này sẽ bị xoá vĩnh viễn!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận xoá',
                    cancelButtonText: 'Huỷ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            method: 'DELETE',
                            success: function () {
                                Swal.fire('Đã xóa!', 'Danh mục đã bị xoá thành công.', 'success');
                                loadData(); // Tải lại danh sách để thấy danh mục đã bị xóa
                            },
                            error: function (xhr, status, error) {
                                console.error(`Lỗi khi xóa danh mục ${id}:`, error);
                                Swal.fire('Lỗi!', 'Không xóa được danh mục, có thể danh mục đang có sản phẩm.', 'error');
                            }
                        });
                    }
                });
            });

            // === 6. KHI NHẤN NÚT "LƯU THAY ĐỔI" TRONG HỘP THOẠI POPUP ===
            modalForm.on('submit', function (e) {
                e.preventDefault();

                // Kiểm tra validation HTML5 cơ bản
                if (!modalForm[0].checkValidity()) {
                    // Nếu form không hợp lệ, trình duyệt sẽ tự hiển thị lỗi
                    // và ngăn chặn submit, không cần làm gì thêm ở đây.
                    return;
                }

                const id = $('#inputId').val(); // Giữ nguyên là string nếu API của bạn dùng string ID
                // Nếu API của bạn dùng int ID, thì mới dùng parseInt: const id = parseInt($('#inputId').val());

                const dataToSend = {
                    maLoaiTui: id, // Server sẽ tự tạo nếu là 0 hoặc chuỗi rỗng
                    tenLoaiTui: $('#inputName').val(),
                    moTa: $('#inputDesc').val()
                };

                // Xác định gửi POST (thêm) hay PUT (sửa) và URL tương ứng
                // Giả định ID là 0 hoặc chuỗi rỗng '' cho việc thêm mới
                const isNew = (id === '0' || id === 0 || id === null || id === '');
                const method = isNew ? 'POST' : 'PUT';
                const url = isNew ? apiUrl : `${apiUrl}/${id}`;

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(dataToSend),
                    success: function (response) {
                        modalDataInstance.hide(); // Ẩn hộp thoại popup
                        Swal.fire(
                            'Thành công!',
                            `Đã ${isNew ? 'thêm mới' : 'cập nhật'} danh mục thành công.`,
                            'success'
                        );
                        loadData(); // Tải lại danh sách để thấy thay đổi
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi lưu danh mục:', error);
                        let errorMsg = 'Có lỗi xảy ra khi lưu danh mục.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                             errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try { // Thử parse responseText nếu nó là JSON
                                const jsonError = JSON.parse(xhr.responseText);
                                errorMsg = jsonError.message || jsonError.errors || xhr.responseText;
                            } catch (e) {
                                errorMsg = xhr.responseText;
                            }
                        }
                        Swal.fire('Lỗi!', errorMsg, 'error');
                    }
                });
            });

            // === 7. CHỨC NĂNG TÌM KIẾM THEO TÊN DANH MỤC (CLIENT-SIDE) ===
            // Gắn sự kiện keyup vào ô input tìm kiếm
            $('#searchInput').on('keyup', function() {
                const searchTerm = $(this).val().toLowerCase().trim(); // Lấy từ khóa và loại bỏ khoảng trắng

                if (searchTerm === '') {
                    renderTable(allCategories); // Nếu rỗng, hiển thị lại toàn bộ dữ liệu
                    return;
                }

                // Lọc dữ liệu từ mảng allCategories
                const filteredCategories = allCategories.filter(item => {
                    return item.tenLoaiTui.toLowerCase().includes(searchTerm);
                });

                renderTable(filteredCategories); // Hiển thị dữ liệu đã lọc
            });

            // Khi click nút Tìm kiếm, chỉ cần kích hoạt sự kiện gõ phím để chạy logic tìm kiếm
            $('#btnSearch').on('click', function() {
                 $('#searchInput').trigger('keyup');
            });

        }); // Hết phần JavaScript khi trang đã sẵn sàng
    </script>
}