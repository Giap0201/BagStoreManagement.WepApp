@{
    ViewData["Title"] = "Quản lý danh mục loại túi";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-table text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Quản lý danh mục loại túi</h4>
    </div>

    <div class="card-body pt-3">
        <!-- Tìm kiếm -->
        <div class="row g-2 align-items-center mb-3">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên danh mục để tìm kiếm...">
            </div>
            <div class="col-md-4 text-md-start text-end">
                <button id="btnSearch" class="btn btn-outline-primary">
                    <i class="mdi mdi-magnify me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>

        <!-- Bảng -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Mã danh mục</th>
                        <th>Tên danh mục</th>
                        <th>Mô tả</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="text-end mt-4">
            <button id="btnAddNew" class="btn btn-primary px-4">
                <i class="mdi mdi-plus-circle-outline me-1"></i> +Thêm danh mục
            </button>
        </div>
    </div>

    <!-- Modal Thêm/Sửa -->
    <div class="modal fade" id="modalData" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Thêm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="errorContainer" class="alert alert-danger d-none"></div>
                    <form id="modalForm">
                        <input type="hidden" id="inputId" />
                        <div class="mb-3">
                            <label class="form-label">Tên danh mục</label>
                            <input type="text" id="inputName" class="form-control" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea id="inputDesc" class="form-control" rows="3" required></textarea>
                            <div class="invalid-feedback"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="modalForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            const apiUrl = '/api/DanhMucLoaiTuiApi';
            const tableBody = $('#tableBody');
            const modalDataInstance = new bootstrap.Modal(document.getElementById('modalData'));
            const modalForm = $('#modalForm');
            const modalLabel = $('#modalLabel');
            const inputId = $('#inputId');
            const inputName = $('#inputName');
            const inputDesc = $('#inputDesc');
            const errorContainer = $('#errorContainer');
            let allCategories = [];

            // Hàm hiển thị lỗi BaseResponse
            function showError(response) {
                inputName.removeClass('is-invalid');
                inputDesc.removeClass('is-invalid');
                modalForm.find('.invalid-feedback').text('');
                errorContainer.addClass('d-none').empty();

                let html = response.message || '';
                if (response.errors && response.errors.length) {
                    html += '<ul>' + response.errors.map(e => `<li>${e.message}</li>`).join('') + '</ul>';
                    response.errors.forEach(e => {
                        if (e.field === 'TenLoaiTui') {
                            inputName.addClass('is-invalid');
                            inputName.closest('.mb-3').find('.invalid-feedback').text(e.message);
                        }
                        if (e.field === 'MoTa') {
                            inputDesc.addClass('is-invalid');
                            inputDesc.closest('.mb-3').find('.invalid-feedback').text(e.message);
                        }
                    });
                }
                if (html) {
                    errorContainer.removeClass('d-none').html(html);
                }
                Swal.fire({ title: 'Lỗi!', html: html || 'Có lỗi xảy ra', icon: 'error' });
            }

            // Load dữ liệu từ API
            function loadData() {
                tableBody.html('<tr><td colspan="4" class="text-center text-muted">Đang tải...</td></tr>');
                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    xhrFields: { withCredentials: true },
                    success: function (res) {
                        if (res.status && res.status.toLowerCase() === 'success') {
                            allCategories = res.data || res;
                            renderTable(allCategories);
                        } else {
                            showError(res);
                            tableBody.html('<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>');
                        }
                    },
                    error: function (xhr) {
                        let msg = xhr.status === 404 ? 'Không tìm thấy API.' : 'Không thể tải dữ liệu.';
                        Swal.fire('Lỗi!', msg, 'error');
                        tableBody.html('<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>');
                    }
                });
            }

            // Render bảng
            function renderTable(data) {
                tableBody.empty();
                if (!data.length) {
                    tableBody.html('<tr><td colspan="4" class="text-center text-info">Không có danh mục nào.</td></tr>');
                    return;
                }
                data.forEach(item => {
                    tableBody.append(`
                        <tr>
                            <td>${item.maLoaiTui}</td>
                            <td>${item.tenLoaiTui}</td>
                            <td>${item.moTa || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning btn-edit" data-id="${item.maLoaiTui}">Sửa</button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${item.maLoaiTui}">Xóa</button>
                            </td>
                        </tr>
                    `);
                });
            }

            // Thêm mới
            $('#btnAddNew').click(function () {
                modalForm[0].reset();
                inputId.val(0);
                inputName.removeClass('is-invalid');
                inputDesc.removeClass('is-invalid');
                errorContainer.addClass('d-none').empty();
                modalLabel.text('Thêm mới danh mục');
                modalDataInstance.show();
            });

            // Sửa
            tableBody.on('click', '.btn-edit', function () {
                const id = $(this).data('id');
                $.ajax({
                    url: `${apiUrl}/${id}`,
                    method: 'GET',
                        xhrFields: {
                            withCredentials: true
                        },
                    success: function (res) {
                        if (res.status && res.status.toLowerCase() === 'success') {
                            const item = res.data || res;
                            inputId.val(item.maLoaiTui);
                            inputName.val(item.tenLoaiTui).removeClass('is-invalid');
                            inputDesc.val(item.moTa).removeClass('is-invalid');
                            errorContainer.addClass('d-none').empty();
                            modalLabel.text('Cập nhật danh mục');
                            modalDataInstance.show();
                        } else {
                            showError(res);
                        }
                    },
                    error: function () {
                        Swal.fire('Lỗi!', 'Không tìm thấy danh mục.', 'error');
                    }
                });
            });

            // Xóa
            tableBody.on('click', '.btn-delete', function () {
                const id = $(this).data('id');
                Swal.fire({
                    title: 'Bạn có chắc chắn xóa không?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy'
                }).then(result => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            method: 'DELETE',
                            xhrFields: {
                                withCredentials: true
                            },
                            success: function (res) {
                                if (res.status && res.status.toLowerCase() === 'success') {
                                    Swal.fire('Đã xóa!', res.message || 'Danh mục đã bị xóa.', 'success');
                                    loadData();
                                } else {
                                    showError(res);
                                }
                            },
                            error: function () {
                                Swal.fire('Lỗi!', 'Không xóa được danh mục.', 'error');
                            }
                        });
                    }
                });
            });

            // Lưu thay đổi (Thêm/Sửa)
            modalForm.on('submit', function (e) {
                e.preventDefault();
                inputName.removeClass('is-invalid');
                inputDesc.removeClass('is-invalid');
                errorContainer.addClass('d-none').empty();

                const data = {
                    maLoaiTui: parseInt(inputId.val()) || 0,
                    tenLoaiTui: inputName.val().trim(),
                    moTa: inputDesc.val().trim()
                };
                const isNew = data.maLoaiTui === 0;
                const url = isNew ? apiUrl : `${apiUrl}/${data.maLoaiTui}`;
                const method = isNew ? 'POST' : 'PUT';

                $.ajax({
                    url: url,
                    method: method,
                    xhrFields: {
                        withCredentials: true
                    },
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (res) {
                        if (res.status && res.status.toLowerCase() === 'success') {
                            modalDataInstance.hide();
                            Swal.fire('Thành công!', res.message || (isNew ? 'Thêm mới thành công' : 'Cập nhật thành công'), 'success');
                            loadData();
                        } else {
                            showError(res);
                        }
                    },
                    error: function (xhr) {
                        showError(xhr.responseJSON || { message: 'Có lỗi xảy ra.' });
                    }
                });
            });

            // Tìm kiếm client-side
            $('#searchInput').on('keyup', function () {
                const term = $(this).val().toLowerCase().trim();
                renderTable(term ? allCategories.filter(c => c.tenLoaiTui.toLowerCase().includes(term)) : allCategories);
            });
            $('#btnSearch').click(() => $('#searchInput').trigger('keyup'));

            // Load dữ liệu ban đầu
            loadData();
        });
    </script>
}
