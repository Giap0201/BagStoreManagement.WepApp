@{
    ViewData["Title"] = "Quản lý danh mục loại túi";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="card shadow-sm border-0 mt-4">
    <!-- Header -->
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-table text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Quản lý danh mục</h4>
    </div>

    <div class="card-body pt-3">
        <!-- Thanh tìm kiếm -->
        <div class="row g-2 align-items-center mb-3">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên danh mục để tìm kiếm...">
            </div>
            <div class="col-md-4 text-md-start text-end">
                <button id="btnSearch" class="btn btn-outline-primary">
                    <i class="mdi mdi-magnify me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Mã danh mục</th>
                        <th scope="col">Tên danh mục</th>
                        <th scope="col">Mô tả</th>
                        <th scope="col">Hành động</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dữ liệu sẽ được load bằng JS -->
                </tbody>
            </table>
        </div>

        <!-- Nút thêm dữ liệu -->
        <div class="text-end mt-4">
            <button id="btnAddNew" class="btn btn-primary px-4">
                <i class="mdi mdi-plus-circle-outline me-1"></i> +Thêm danh mục
            </button>
        </div>
    </div>

    <!-- Modal Thêm/Sửa chung -->
    <div class="modal fade" id="modalData" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Thêm mới danh mục</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div id="errorContainer" class="alert alert-danger d-none" role="alert"></div>
                    <form id="modalForm">
                        <input type="hidden" id="inputId" name="Id" />
                        <div class="mb-3">
                            <label for="inputName" class="form-label">Tên danh mục</label>
                            <input type="text" class="form-control" id="inputName" name="Name" required>
                            <div class="invalid-feedback">Vui lòng nhập tên danh mục (tối thiểu 3 ký tự).</div>
                        </div>
                        <div class="mb-3">
                            <label for="inputDesc" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="inputDesc" name="Desc" rows="3" required></textarea>
                            <div class="invalid-feedback">Vui lòng nhập mô tả danh mục.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" form="modalForm" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Thêm các thư viện cần thiết -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Đảm bảo $.cookie tương thích với jQuery Cookie hoặc js-cookie
        if (typeof $.cookie === 'undefined' && typeof Cookies !== 'undefined') {
            $.cookie = function (name, value, options) {
                if (typeof value !== 'undefined') {
                    Cookies.set(name, value, options);
                } else {
                    return Cookies.get(name);
                }
            };
        }

        $(document).ready(function () {
            // === 1. CÁC THÔNG TIN CẦN THIẾT BAN ĐẦU ===
            const baseUrl = "https://localhost:5001"; // Thay bằng URL thực tế từ Postman
            const apiUrl = `${baseUrl}/api/DanhMucLoaiTuiApi`; // URL API cho danh mục loại túi
            const tableBody = $('#tableBody');
            const modalDataInstance = new bootstrap.Modal(document.getElementById('modalData'));
            const modalLabel = $('#modalLabel');
            const modalForm = $('#modalForm');
            const inputName = $('#inputName');
            const inputDesc = $('#inputDesc');
            const errorContainer = $('#errorContainer');
            let allCategories = [];

            // Hàm tạo headers cho AJAX, chỉ gửi Authorization nếu token tồn tại
            function getAjaxHeaders() {
                const token = localStorage.getItem("accessToken");
                return token ? { "Authorization": "Bearer " + token } : {};
            }

            // === 2. HÀM RENDER BẢNG DỮ LIỆU ===
            function renderTable(categoriesToRender) {
                tableBody.empty();

                if (categoriesToRender.length === 0) {
                    tableBody.html('<tr><td colspan="4" class="text-center text-info">Không có danh mục nào.</td></tr>');
                    return;
                }

                $.each(categoriesToRender, function (index, item) {
                    const row = `
                        <tr>
                            <td>${item.maLoaiTui}</td>
                            <td>${item.tenLoaiTui}</td>
                            <td>${item.moTa || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning me-1 btn-edit" data-id="${item.maLoaiTui}">
                                    Sửa
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${item.maLoaiTui}">
                                    Xóa
                                </button>
                            </td>
                        </tr>`;
                    tableBody.append(row);
                });
            }

            // === 3. HÀM CHÍNH: LẤY DỮ LIỆU TỪ SERVER ===
            function loadData() {
                tableBody.html('<tr><td colspan="4" class="text-center text-muted">Đang tải dữ liệu...</td></tr>');

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    dataType: 'json',
                    headers: getAjaxHeaders(),
                    success: function (response) {
                        if (response.success !== false) {
                            allCategories = response.data || response; // Hỗ trợ cả mảng trực tiếp và { success: true, data: [...] }
                            renderTable(allCategories);
                        } else {
                            let errorMsg = response.message || 'Lỗi khi tải dữ liệu.';
                            if (response.errors && response.errors.length > 0) {
                                errorMsg += '<ul>' + response.errors.map(e => `<li>${e.errorMessage}</li>`).join('') + '</ul>';
                            }
                            Swal.fire({
                                title: 'Lỗi!',
                                html: errorMsg,
                                icon: 'error'
                            });
                            tableBody.html('<tr class="table-danger"><td colspan="4" class="text-center">Lỗi khi tải dữ liệu.</td></tr>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi tải dữ liệu:', error);
                        const errorMsg = xhr.status === 401
                            ? 'Bạn chưa đăng nhập hoặc token không hợp lệ.'
                            : `Không thể tải dữ liệu danh mục. Mã lỗi: ${xhr.status}`;
                        Swal.fire('Lỗi!', errorMsg, 'error');
                    }
                });
            }

            // Gọi loadData khi trang tải
            loadData();

            // === 4. KHI NHẤN NÚT "THÊM DANH MỤC" ===
            $('#btnAddNew').on('click', function () {
                modalForm[0].reset();
                inputName.removeClass('is-invalid');
                inputDesc.removeClass('is-invalid');
                errorContainer.addClass('d-none').empty();
                $('#inputId').val(0);
                modalLabel.text('Thêm mới danh mục');
                modalDataInstance.show();
            });

            // === 5. KHI NHẤN NÚT "SỬA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-edit', function () {
                const id = $(this).data('id');

                $.ajax({
                    url: `${apiUrl}/${id}`,
                    method: 'GET',
                    dataType: 'json',
                    headers: getAjaxHeaders(),
                    success: function (response) {
                        if (response.success !== false) {
                            const item = response.data || response;
                            $('#inputId').val(item.maLoaiTui);
                            $('#inputName').val(item.tenLoaiTui).removeClass('is-invalid');
                            $('#inputDesc').val(item.moTa).removeClass('is-invalid');
                            errorContainer.addClass('d-none').empty();
                            modalLabel.text('Cập nhật danh mục');
                            modalDataInstance.show();
                        } else {
                            let errorMsg = response.message || 'Lỗi khi lấy danh mục.';
                            if (response.errors && response.errors.length > 0) {
                                errorMsg += '<ul>' + response.errors.map(e => `<li>${e.errorMessage}</li>`).join('') + '</ul>';
                            }
                            Swal.fire({
                                title: 'Lỗi!',
                                html: errorMsg,
                                icon: 'error'
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(`Lỗi khi lấy danh mục ${id}:`, error);
                        const errorMsg = xhr.status === 401
                            ? 'Bạn chưa đăng nhập hoặc token không hợp lệ.'
                            : `Không tìm thấy danh mục này. Mã lỗi: ${xhr.status}`;
                        Swal.fire('Lỗi!', errorMsg, 'error');
                    }
                });
            });

            // === 6. KHI NHẤN NÚT "XÓA" TRÊN MỖI DÒNG ===
            tableBody.on('click', '.btn-delete', function () {
                const id = $(this).data('id');

                Swal.fire({
                    title: 'Bạn có chắc chắn xóa không?',
                    text: 'Danh mục này sẽ bị xóa vĩnh viễn!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận xóa',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            method: 'DELETE',
                            headers: getAjaxHeaders(),
                            success: function (response) {
                                if (response.success !== false) {
                                    Swal.fire('Đã xóa!', 'Danh mục đã bị xóa thành công.', 'success');
                                    loadData();
                                } else {
                                    let errorMsg = response.message || 'Lỗi khi xóa danh mục.';
                                    if (response.errors && response.errors.length > 0) {
                                        errorMsg += '<ul>' + response.errors.map(e => `<li>${e.errorMessage}</li>`).join('') + '</ul>';
                                    }
                                    Swal.fire({
                                        title: 'Lỗi!',
                                        html: errorMsg,
                                        icon: 'error'
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error(`Lỗi khi xóa danh mục ${id}:`, error);
                                const errorMsg = xhr.status === 401
                                    ? 'Bạn chưa đăng nhập hoặc token không hợp lệ.'
                                    : 'Không xóa được danh mục, có thể danh mục đang được sử dụng.';
                                Swal.fire('Lỗi!', errorMsg, 'error');
                            }
                        });
                    }
                });
            });

            // === 7. KHI NHẤN NÚT "LƯU THAY ĐỔI" TRONG MODAL ===
            modalForm.on('submit', function (e) {
                e.preventDefault();

                // Client-side validation
                const tenLoaiTui = inputName.val().trim();
                const moTa = inputDesc.val().trim();
                let isValid = true;

                if (tenLoaiTui.length < 3) {
                    inputName.addClass('is-invalid');
                    inputName.next('.invalid-feedback').text('Tên danh mục phải có ít nhất 3 ký tự.');
                    isValid = false;
                } else {
                    inputName.removeClass('is-invalid');
                }

                if (moTa === '') {
                    inputDesc.addClass('is-invalid');
                    inputDesc.next('.invalid-feedback').text('Mô tả không được bỏ trống.');
                    isValid = false;
                } else {
                    inputDesc.removeClass('is-invalid');
                }

                if (!isValid) {
                    return;
                }

                const id = $('#inputId').val();
                const dataToSend = {
                    maLoaiTui: id,
                    tenLoaiTui: tenLoaiTui,
                    moTa: moTa
                };

                const isNew = (id === '0' || id === 0 || id === null || id === '');
                const method = isNew ? 'POST' : 'PUT';
                const url = isNew ? apiUrl : `${apiUrl}/${id}`;

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    headers: getAjaxHeaders(),
                    data: JSON.stringify(dataToSend),
                    success: function (response) {
                        if (response.success !== false) {
                            modalDataInstance.hide();
                            Swal.fire('Thành công!', `Đã ${isNew ? 'thêm mới' : 'cập nhật'} danh mục thành công.`, 'success');
                            loadData();
                        } else {
                            let errorMsg = response.message || 'Có lỗi xảy ra khi lưu danh mục.';
                            if (response.errors && response.errors.length > 0) {
                                errorMsg = '<ul>' + response.errors.map(e => `<li>${e.errorMessage}</li>`).join('') + '</ul>';
                                errorContainer.removeClass('d-none').html(errorMsg);
                            } else {
                                errorContainer.addClass('d-none').empty();
                            }
                            Swal.fire({
                                title: 'Lỗi!',
                                html: errorMsg,
                                icon: 'error'
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi khi lưu danh mục:', error);
                        let errorMsg = xhr.status === 401
                            ? 'Bạn chưa đăng nhập hoặc token không hợp lệ.'
                            : 'Có lỗi xảy ra khi lưu danh mục.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                            if (xhr.responseJSON.errors && xhr.responseJSON.errors.length > 0) {
                                errorMsg = '<ul>' + xhr.responseJSON.errors.map(e => `<li>${e.errorMessage}</li>`).join('') + '</ul>';
                                errorContainer.removeClass('d-none').html(errorMsg);
                            } else {
                                errorContainer.addClass('d-none').empty();
                            }
                        }
                        Swal.fire('Lỗi!', errorMsg, 'error');
                    }
                });
            });

            // === 8. CHỨC NĂNG TÌM KIẾM THEO TÊN (CLIENT-SIDE) ===
            $('#searchInput').on('keyup', function () {
                const searchTerm = $(this).val().toLowerCase().trim();

                if (searchTerm === '') {
                    renderTable(allCategories);
                    return;
                }

                const filteredCategories = allCategories.filter(item =>
                    item.tenLoaiTui.toLowerCase().includes(searchTerm)
                );

                renderTable(filteredCategories);
            });

            // Khi click nút Tìm kiếm, kích hoạt sự kiện keyup
            $('#btnSearch').on('click', function () {
                $('#searchInput').trigger('keyup');
            });
        });
    </script>
}