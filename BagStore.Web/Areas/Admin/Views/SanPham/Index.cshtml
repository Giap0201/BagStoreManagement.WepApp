﻿
@model List<BagStore.Web.Models.ViewModels.SanPhams.SanPhamResponseDto>

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-4">
    <h3 class="text-primary mb-3"><i class="bi bi-box"></i> Quản lý sản phẩm</h3>

    <div class="row mb-3 align-items-center">
        <div class="col-md-7">
            <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên hoặc mã sản phẩm...">
        </div>
        <div class="col-md-3">
            <button id="btnSearch" class="btn btn-primary w-100"><i class="bi bi-search"></i> Tìm kiếm</button>
        </div>
        <div class="col-md-2 text-end">
            <button id="btnAddNewProduct" class="btn btn-success w-100"><i class="bi bi-plus-circle"></i> Thêm mới</button>
        </div>
    </div>

    <div id="tableAlertMessage" class="mt-3"></div>

    <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped text-center align-middle" id="tblSanPham">
            <thead class="table-light">
                <tr>
                    <th>Mã SP</th>
                    <th>Tên sản phẩm</th>
                    <th>Loại túi</th>
                    <th>Thương hiệu</th>
                    <th>Chất liệu</th>
                    <th>Ảnh</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @* Nội dung bảng sẽ được load bằng AJAX *@
            </tbody>
        </table>
        <nav aria-label="Page navigation" id="paginationContainer" style="display: none;">
            <ul class="pagination justify-content-center" id="paginationControls">
            </ul>
        </nav>
    </div>

    <div class="card mt-4" id="productFormCard" style="display: none;">
        @* Ẩn form ban đầu *@
        <div class="card-header bg-light">
            <h5 class="mb-0" id="formTitle">Thêm mới sản phẩm</h5>
        </div>
        <div class="card-body">
            <div id="formAlertMessage"></div>

            <form id="productForm" enctype="multipart/form-data">
                <input type="hidden" id="MaSP" name="MaSP" value="0" />
                <input type="hidden" id="AnhChinhHienTai" name="AnhChinhHienTai" />

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="TenSP" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="TenSP" name="TenSP" required />
                        <div class="text-danger small field-error" id="error-TenSP"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MaLoaiTui" class="form-label">Loại túi <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaLoaiTui" name="MaLoaiTui" required>
                            <option value="">-- Chọn loại túi --</option>
                            @foreach (var item in ViewBag.LoaiTuiList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaLoaiTui"></div>
                    </div>

                    <div class="col-md-12">
                        <label for="MoTaChiTiet" class="form-label">Mô tả chi tiết <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="MoTaChiTiet" name="MoTaChiTiet" rows="3" required></textarea>
                        <div class="text-danger small field-error" id="error-MoTaChiTiet"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="MaThuongHieu" class="form-label">Thương hiệu <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaThuongHieu" name="MaThuongHieu" required>
                            <option value="">-- Chọn thương hiệu --</option>
                            @foreach (var item in ViewBag.ThuongHieuList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaThuongHieu"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MaChatLieu" class="form-label">Chất liệu <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaChatLieu" name="MaChatLieu" required>
                            <option value="">-- Chọn chất liệu --</option>
                            @foreach (var item in ViewBag.ChatLieuList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaChatLieu"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="MetaTitle" class="form-label">Meta Title</label>
                        <input type="text" class="form-control" id="MetaTitle" name="MetaTitle" maxlength="200" />
                        <div class="text-danger small field-error" id="error-MetaTitle"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MetaDescription" class="form-label">Meta Description</label>
                        <textarea class="form-control" id="MetaDescription" name="MetaDescription" rows="2" maxlength="500"></textarea>
                        <div class="text-danger small field-error" id="error-MetaDescription"></div>
                    </div>

                    <div class="col-md-12">
                        <label for="AnhChinh" class="form-label">Ảnh sản phẩm</label>
                        <input type="file" class="form-control" id="AnhChinh" name="AnhChinh" accept="image/*" />
                        <small class="form-text text-muted">Chọn ảnh mới nếu bạn muốn thay đổi ảnh hiện tại.</small>
                        <div class="mt-2" id="anhPreviewContainer" style="display: none;">
                            <img id="previewImage" src="" alt="Ảnh sản phẩm" class="img-thumbnail" style="max-width: 150px;" />
                        </div>
                        <div class="text-danger small field-error" id="error-AnhChinh"></div>
                    </div>

                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary px-4 me-2"><i class="bi bi-save"></i> <span id="btnSubmitText">Lưu</span></button>
                        <button type="button" class="btn btn-secondary px-4" id="btnCancelForm"><i class="bi bi-x-circle"></i> Hủy</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {

    <script>
           // --- ĐỊNH NGHĨA HÀM ---
            let currentPage = 1;
            const pageSize = 5; // <-- Có thể đổi số lượng (ví dụ: 10)
            let currentSearch = "";
           const apiUrl = '/api/SanPhamApi';

              // Hàm tiện ích hiển thị thông báo chung
        function showAlert(selector, message, isSuccess) {
               const alertElement = $(selector);
               alertElement.html(`<div class="alert alert-${isSuccess ? 'success' : 'danger'} alert-dismissible fade show" role="alert">
                                       ${message}
                                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                   </div>`)
                           .removeClass('d-none');
           }

           // Xóa tất cả các loại lỗi trên form
           function clearFormErrors() {
               $('.field-error').text('');
               $('.form-control, .form-select').removeClass('is-invalid');
               $('#formAlertMessage').empty().addClass('d-none');
           }

           // Reset form về trạng thái ban đầu và ẩn đi
           function resetAndHideForm() {
               $('#productForm')[0].reset();
               $('#MaSP').val(0);
               $('#formTitle').text('Thêm mới sản phẩm');
               $('#btnSubmitText').text('Lưu');
               $('#previewImage').attr('src', '');
               $('#anhPreviewContainer').hide(); // Ẩn preview
               $('#AnhChinhHienTai').val('');

               clearFormErrors(); // Gọi hàm xóa lỗi chi tiết
               $('#productFormCard').hide();
           }

           // Hiển thị form
           function showAndScrollToForm() {
               $('#productFormCard').show();
           }

           // Hiển thị danh sách sản phẩm vào bảng
           function renderTable(products) {
               const tableBody = $('#tableBody');
               tableBody.empty();
               if (!products || products.length === 0) {
                   tableBody.html('<tr><td colspan="7" class="text-center text-info">Không tìm thấy sản phẩm nào.</td></tr>');
                   return;
               }

               products.forEach(product => {
                   let imgHtml = '(Không có ảnh)';
                   if (product.anhChinh) {
                       imgHtml = `<img src="${product.anhChinh}" alt="SP" style="max-width:50px; max-height:50px; object-fit: cover;">`;
                   }

                   tableBody.append(`
                       <tr data-id="${product.maSP}">
                           <td>${product.maSP}</td>
                           <td class="text-start">${product.tenSP}</td>
                           <td>${product.tenLoaiTui || 'N/A'}</td>
                           <td>${product.tenThuongHieu || 'N/A'}</td>
                           <td>${product.tenChatLieu || 'N/A'}</td>
                           <td>${imgHtml}</td>
                           <td>
                                <button class="btn btn-info btn-sm btnViewDetail" data-id="${product.maSP}"><i class="bi bi-eye"></i> Xem chi tiết</button>
                                <button class="btn btn-warning btn-sm btnEdit" data-id="${product.maSP}"><i class="bi bi-pencil"></i> Sửa</button>
                                <button class="btn btn-danger btn-sm btnDelete" data-id="${product.maSP}"><i class="bi bi-trash"></i> Xoá</button>

                           </td>
                       </tr>
                   `);
               });
           }

           //ham phan trang
           function renderPagination(totalPages, page) {
            const $pagination = $('#paginationControls');
            $pagination.empty();
            const $container = $('#paginationContainer');

            // Ẩn thanh phân trang nếu chỉ có 1 trang
            if (totalPages <= 1) {
                $container.hide();
                return;
            }
            $container.show();

            // Nút "Trang trước"
            let prevDisabled = (page === 1) ? "disabled" : "";
            $pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" data-page="${page - 1}">&laquo;</a>
                </li>
            `);

            // Các nút số trang
            for (let i = 1; i <= totalPages; i++) {
                let activeClass = (i === page) ? "active" : "";
                $pagination.append(`
                    <li class="page-item ${activeClass}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }

            // Nút "Trang sau"
            let nextDisabled = (page === totalPages) ? "disabled" : "";
            $pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" data-page="${page + 1}">&raquo;</a>
                </li>
            `);
        }

           // Tải danh sách sản phẩm từ API (Dùng $.ajax{})
           function loadProducts() {
               const tableBody = $('#tableBody');
               tableBody.html('<tr><td colspan="7" class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>');
               $('#tableAlertMessage').empty().addClass('d-none');

               currentSearch = $("#searchInput").val() || '';
               $.ajax({
                url: apiUrl,
                method: 'GET',
                data: {
                    page: currentPage,       // Gửi số trang
                    pageSize: pageSize,      // Gửi kích thước trang
                    search: currentSearch    // Gửi từ khóa (phải là 'search' để khớp API)
                },
                success: function (response) {
                    if (response && response.status === 'success' && response.data) {
                        // response.data bây giờ là một đối tượng PageResult
                        const pagedResult = response.data;

                        // 1. Dùng pagedResult.data (list sản phẩm) để vẽ bảng
                        renderTable(pagedResult.data || []);

                        // 2. Tính toán tổng số trang
                        totalPages = Math.ceil(pagedResult.total / pagedResult.pageSize);

                        // 3. Dùng totalPages và pagedResult.page (trang hiện tại) để vẽ phân trang
                        renderPagination(totalPages, pagedResult.page);

                    } else {
                        showAlert('#tableAlertMessage', response.message || 'Lỗi tải dữ liệu.', false);
                        tableBody.html('<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>');
                        renderPagination(0, 0); // Ẩn phân trang nếu lỗi
                    }
                },
                error: function (xhr) {
                    showAlert('#tableAlertMessage', `Lỗi kết nối (${xhr.status}): ${xhr.statusText}`, false);
                    tableBody.html('<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối.</td></tr>');
                    renderPagination(0, 0); // Ẩn phân trang nếu lỗi
                }
            });
           }

           // Điền dữ liệu sản phẩm vào form để chỉnh sửa
           function fillFormForEdit(product) {
               clearFormErrors();
               $('#MaSP').val(product.maSP);
               $('#TenSP').val(product.tenSP);
               $('#MoTaChiTiet').val(product.moTaChiTiet);
               $('#MetaTitle').val(product.metaTitle);
               $('#MetaDescription').val(product.metaDescription);
               $('#MaLoaiTui').val(String(product.maLoaiTui));
               $('#MaThuongHieu').val(String(product.maThuongHieu));
               $('#MaChatLieu').val(String(product.maChatLieu));

               if (product.anhChinh) {
                   $('#previewImage').attr('src', product.anhChinh);
                   $('#anhPreviewContainer').show();
                   $('#AnhChinhHienTai').val(product.anhChinh);
               } else {
                   $('#previewImage').attr('src', '');
                   $('#anhPreviewContainer').hide();
                   $('#AnhChinhHienTai').val('');
               }
               $('#formTitle').text(`Cập nhật: ${product.tenSP} (Mã: ${product.maSP})`);
               $('#btnSubmitText').text('Cập nhật');
               showAndScrollToForm(); // Hiển thị form
           }

           // Xử lý và hiển thị lỗi validation chi tiết
           function handleValidationErrors(errors) {
               let errorMessagesHtml = '';
               errors.forEach(function(error) {
                   let fieldName = error.field || error.fieldName || error.FieldName;
                   let errorMessage = error.message || error.errorMessage || error.ErrorMessage;

                   if (!fieldName) {
                       errorMessagesHtml += `<li>Lỗi không xác định: ${errorMessage}</li>`;
                       return;
                   }

                   let errorFieldId = "error-" + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                   var errorElement = $(errorFieldId);
                   if (errorElement.length) {
                       errorElement.text(errorMessage);
                       errorElement.prev('.form-control, .form-select').addClass('is-invalid');
                   } else {
                       errorMessagesHtml += `<li><strong>${fieldName}:</strong> ${errorMessage}</li>`;
                   }
               });

               if(errorMessagesHtml) {
                   showAlert('#formAlertMessage', 'Vui lòng kiểm tra lại dữ liệu:<ul class="mb-0">' + errorMessagesHtml + '</ul>', false);
               } else {
                   showAlert('#formAlertMessage', 'Vui lòng sửa các lỗi được đánh dấu bên dưới.', false);
               }
           }


           // --- SỰ KIỆN (BÊN TRONG DOCUMENT.READY) ---
           $(document).ready(function () {

               // 1. Nhấn nút "Thêm mới"
               $('#btnAddNewProduct').on('click', function() {
                   resetAndHideForm();
                   $('#formTitle').text('Thêm mới sản phẩm');
                   $('#btnSubmitText').text('Lưu');
                   showAndScrollToForm();
               });

               // 2. Nhấn nút "Hủy"
               $('#btnCancelForm').on('click', resetAndHideForm);

               // 4. Submit form (Thêm mới / Cập nhật)
               $(document).on('submit', '#productForm', function (e) {
                   e.preventDefault();
                   clearFormErrors(); // Xóa lỗi chi tiết cũ

                   const formData = new FormData(this);
                   const maSP = $('#MaSP').val();
                   const isNew = (maSP == 0);
                   const url = isNew ? apiUrl : `${apiUrl}/${maSP}`;
                   const method = isNew ? 'POST' : 'PUT';
                   const submitButton = $(this).find('button[type="submit"]');
                   const originalButtonText = $('#btnSubmitText').text();
                   submitButton.prop('disabled', true);
                   $('#btnSubmitText').html('<span class="spinner-border spinner-border-sm"></span> Đang lưu...');

                   $.ajax({
                       url: url,
                       type: method,
                       data: formData,
                       processData: false,
                       contentType: false,
                       success: function (response) {
                           if (response && response.status === 'success') {
                               showAlert('#tableAlertMessage', response.message || (isNew ? 'Thêm thành công!' : 'Cập nhật!'), true);
                               resetAndHideForm();
                               loadProducts();
                           } else {
                               // Lỗi nghiệp vụ (từ server)
                               showAlert('#formAlertMessage', response.message || 'Có lỗi xảy ra.', false);
                           }
                       },
                       error: function (xhr) {
                           // HÀM XỬ LÝ LỖI CHI TIẾT
                           if (xhr.responseJSON) {
                               var errorResponse = xhr.responseJSON;
                               if (errorResponse.errors && Array.isArray(errorResponse.errors)) {
                                   // 1. Lỗi Validation
                                   handleValidationErrors(errorResponse.errors);
                               }
                               else if (errorResponse.message) {
                                   // 2. Lỗi nghiệp vụ khác
                                   showAlert('#formAlertMessage', errorResponse.message, false);
                               }
                               else {
                                   // 3. Lỗi không rõ
                                   showAlert('#formAlertMessage', 'Lỗi không xác định từ server.', false);
                               }
                           } else {
                               // 4. Lỗi server (500)
                               showAlert('#formAlertMessage', `Lỗi ${xhr.status}: ${xhr.statusText}.`, false);
                           }
                       },
                       complete: function() {
                           // Luôn khôi phục nút
                           submitButton.prop('disabled', false);
                           $('#btnSubmitText').text(originalButtonText);
                       }
                   });
               });

               // 5. Nhấn nút "Sửa"
               $('#tableBody').on('click', '.btnEdit', function () {
                   const id = $(this).data('id');
                   resetAndHideForm();
                   $('#tableAlertMessage').empty().addClass('d-none');

                   // Dùng $.ajax{} để tải chi tiết
                   $.ajax({
                       url: `${apiUrl}/${id}`,
                       method: 'GET',
                       success: function (response) {
                           if (response && response.status === 'success' && response.data) {
                               fillFormForEdit(response.data);
                           } else {
                               showAlert('#tableAlertMessage', response.message || 'Không tìm thấy dữ liệu.', false);
                               resetAndHideForm();
                           }
                       },
                       error: function (xhr) {
                           showAlert('#tableAlertMessage', `Lỗi ${xhr.status} khi tải chi tiết.`, false);
                           resetAndHideForm();
                       }
                   });
               });

               // 6. Nhấn nút "Xóa"
               $('#tableBody').on('click', '.btnDelete', function () {
                   const id = $(this).data('id');
                   const tenSP = $(this).closest('tr').find('td:eq(1)').text();

                   Swal.fire({
                       title: 'Xác nhận xóa?',
                       html: `Bạn có chắc muốn xóa <strong>${tenSP}</strong> (Mã: ${id})?`,
                       icon: 'warning',
                       showCancelButton: true,
                       confirmButtonText: 'Đồng ý xóa',
                       cancelButtonText: 'Hủy bỏ'
                   }).then((result) => {
                       if (result.isConfirmed) {
                           $.ajax({
                               url: `${apiUrl}/${id}`,
                               method: 'DELETE',
                               success: function (response) {
                                   if (response && response.status === 'success') {
                                       Swal.fire('Đã xóa!', response.message || 'Đã xóa.', 'success');
                                       // TỐI GIẢN: Tải lại bảng (thay vì fadeOut)
                                       loadProducts();
                                   } else {
                                       Swal.fire('Lỗi!', response.message || 'Không thể xóa.', 'error');
                                   }
                               },
                               error: function (xhr) {
                                   Swal.fire('Lỗi!', `Lỗi ${xhr.status} khi xóa.`, 'error');
                               }
                           });
                       }
                   });
               });

              // HÀM TÌM KIẾM ---
            function performSearch() {
                currentPage = 1; //  Khi tìm kiếm, luôn quay về trang 1
                loadProducts();
            }
            $('#btnSearch').on('click', performSearch);
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) { // 13 là phím Enter
                    performSearch();
                }
            });

            // ---  THÊM SỰ KIỆN CLICK CHO NÚT PHÂN TRANG ---
             $('#paginationControls').on('click', 'a.page-link', function(e) {
                e.preventDefault(); // Ngăn trình duyệt tải lại trang
                const $link = $(this);

                // Không làm gì nếu nút bị vô hiệu hóa
                if ($link.closest('li').hasClass('disabled') || $link.closest('li').hasClass('active')) {
                    return;
                }

                const newPage = $(this).data('page'); // Lấy số trang từ 'data-page'

                if (newPage && newPage !== currentPage) {
                    currentPage = newPage; // Cập nhật trang hiện tại
                    loadProducts(); // Tải lại dữ liệu cho trang mới
                }
            });

               // 8. Nhấn nút "Xem chi tiết"
               $('#tableBody').on('click', '.btnViewDetail', function () {
                   const id = $(this).data('id');
                   window.location.href = `/Admin/SanPham/Detail/${id}`;
               });

               // --- KHỞI TẠO ---
               loadProducts(); // Tải danh sách sản phẩm ban đầu
           });
    </script>
}