@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<h2>Danh sách sản phẩm</h2>

<div class="mb-3">
    <input type="number" id="txtMaSP" placeholder="Nhập mã sản phẩm" class="form-control" style="width:200px; display:inline-block;" />
    <button id="btnTimSP" type="button" class="btn btn-primary">Tìm sản phẩm</button>
</div>

<table id="tblSanPham" class="table table-bordered">
    <thead>
        <tr>
            <th>Mã SP</th>
            <th>Tên SP</th>
            <th>Loại túi</th>
            <th>Thương hiệu</th>
            <th>Chất liệu</th>
            <th>Ảnh chính</th>
            <th>Giá bán</th>
            <th>Số lượng</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
    <!-- 1) đảm bảo jQuery được load trước script này -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        (function($){
            $(function(){

                // Debug helper: kiểm tra jQuery & element tồn tại
                console.log('jQuery version:', $.fn.jquery);
                console.log('#btnTimSP exists:', $('#btnTimSP').length);
                console.log('#txtMaSP exists:', $('#txtMaSP').length);

                // Gọi khi click (dùng delegated binding an toàn)
                $(document).on('click', '#btnTimSP', function (e) {
                    e.preventDefault(); // tránh submit nếu bên trong form
                    console.log('btnTimSP clicked');

                    var maSP = $('#txtMaSP').val();
                    if (!maSP) {
                        alert('Vui lòng nhập mã sản phẩm');
                        return;
                    }

                    // gọi API (API controller RESTful)
                    var url = '/api/SanPhamApi/' + encodeURIComponent(maSP);

                    console.log('Calling URL:', url);

                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        success: function (sp) {
                            console.log('API response:', sp);

                            // Nếu API trả 404 hoặc null thì sp có thể undefined
                            if (!sp || !sp.maSP) {
                                alert('Không tìm thấy sản phẩm với mã ' + maSP);
                                $('#tblSanPham tbody').empty();
                                return;
                            }

                            // render 1 row
                            $('#tblSanPham tbody').empty();

                            const chiTiet = (sp.chiTietSanPhams && sp.chiTietSanPhams.length > 0) ? sp.chiTietSanPhams[0] : {};
                            const giaBan = chiTiet.giaBan ? Number(chiTiet.giaBan).toLocaleString('vi-VN') + '₫' : '';
                            const soLuong = chiTiet.soLuongTon || '';
                            const anh = (sp.anhSanPhams && sp.anhSanPhams.length > 0) ? sp.anhSanPhams[0].duongDan : '/images/no-image.png';

                            var row = `
                                <tr>
                                    <td>${sp.maSP}</td>
                                    <td>${sp.tenSP || ''}</td>
                                    <td>${sp.tenLoaiTui || ''}</td>
                                    <td>${sp.tenThuongHieu || ''}</td>
                                    <td>${sp.tenChatLieu || ''}</td>
                                    <td><img src="${anh}" width="80" onerror="this.src='/images/no-image.png'"/></td>
                                    <td>${giaBan}</td>
                                    <td>${soLuong}</td>
                                </tr>`;
                            $('#tblSanPham tbody').append(row);
                        },
                        error: function (xhr, status, error) {
                            console.error('AJAX error:', status, error, xhr);
                            if (xhr.status === 404) {
                                alert('Không tìm thấy sản phẩm với mã ' + maSP);
                                $('#tblSanPham tbody').empty();
                            } else {
                                alert('Lỗi khi tải sản phẩm: ' + (xhr.responseJSON?.message || xhr.responseText || error));
                            }
                        }
                    });
                });

                // Optionally: Enter key in input will trigger search
                $('#txtMaSP').on('keypress', function(e){
                    if (e.which === 13) { // Enter
                        $('#btnTimSP').click();
                    }
                });

            });
        })(jQuery);
    </script>
}
