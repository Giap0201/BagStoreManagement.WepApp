@model List<BagStore.Web.Models.ViewModels.SanPhams.SanPhamResponseDto>

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-4">
    <h3 class="text-primary mb-3"><i class="bi bi-box"></i> Quản lý sản phẩm</h3>

    <div class="row mb-3 align-items-center">
        <div class="col-md-7">
            <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên hoặc mã sản phẩm...">
        </div>
        <div class="col-md-3">
            <button id="btnSearch" class="btn btn-primary w-100"><i class="bi bi-search"></i> Tìm kiếm</button>
        </div>
        <div class="col-md-2 text-end">
            <button id="btnAddNewProduct" class="btn btn-success w-100"><i class="bi bi-plus-circle"></i> Thêm mới</button>
        </div>
    </div>

    <div id="tableAlertMessage" class="mt-3"></div>

    <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped text-center align-middle" id="tblSanPham">
            <thead class="table-light">
                <tr>
                    <th>Mã SP</th>
                    <th>Tên sản phẩm</th>
                    <th>Loại túi</th>
                    <th>Thương hiệu</th>
                    <th>Chất liệu</th>
                    <th>Ảnh</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @* Nội dung bảng sẽ được load bằng AJAX *@
            </tbody>
        </table>
    </div>

    <div class="card mt-4" id="productFormCard" style="display: none;">
        @* Ẩn form ban đầu *@
        <div class="card-header bg-light">
            <h5 class="mb-0" id="formTitle">Thêm mới sản phẩm</h5>
        </div>
        <div class="card-body">
            <div id="formAlertMessage"></div>

            <form id="productForm" enctype="multipart/form-data">
                <input type="hidden" id="MaSP" name="MaSP" value="0" />
                <input type="hidden" id="AnhChinhHienTai" name="AnhChinhHienTai" />

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="TenSP" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="TenSP" name="TenSP" required />
                        <div class="text-danger small field-error" id="error-TenSP"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MaLoaiTui" class="form-label">Loại túi <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaLoaiTui" name="MaLoaiTui" required>
                            <option value="">-- Chọn loại túi --</option>
                            @foreach (var item in ViewBag.LoaiTuiList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaLoaiTui"></div>
                    </div>

                    <div class="col-md-12">
                        <label for="MoTaChiTiet" class="form-label">Mô tả chi tiết <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="MoTaChiTiet" name="MoTaChiTiet" rows="3" required></textarea>
                        <div class="text-danger small field-error" id="error-MoTaChiTiet"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="MaThuongHieu" class="form-label">Thương hiệu <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaThuongHieu" name="MaThuongHieu" required>
                            <option value="">-- Chọn thương hiệu --</option>
                            @foreach (var item in ViewBag.ThuongHieuList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaThuongHieu"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MaChatLieu" class="form-label">Chất liệu <span class="text-danger">*</span></label>
                        <select class="form-select" id="MaChatLieu" name="MaChatLieu" required>
                            <option value="">-- Chọn chất liệu --</option>
                            @foreach (var item in ViewBag.ChatLieuList)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <div class="text-danger small field-error" id="error-MaChatLieu"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="MetaTitle" class="form-label">Meta Title</label>
                        <input type="text" class="form-control" id="MetaTitle" name="MetaTitle" maxlength="200" />
                        <div class="text-danger small field-error" id="error-MetaTitle"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="MetaDescription" class="form-label">Meta Description</label>
                        <textarea class="form-control" id="MetaDescription" name="MetaDescription" rows="2" maxlength="500"></textarea>
                        <div class="text-danger small field-error" id="error-MetaDescription"></div>
                    </div>

                    <div class="col-md-12">
                        <label for="AnhChinh" class="form-label">Ảnh sản phẩm</label>
                        <input type="file" class="form-control" id="AnhChinh" name="AnhChinh" accept="image/*" />
                        <small class="form-text text-muted">Chọn ảnh mới nếu bạn muốn thay đổi ảnh hiện tại.</small>
                        <div class="mt-2" id="anhPreviewContainer" style="display: none;">
                            <img id="previewImage" src="" alt="Ảnh sản phẩm" class="img-thumbnail" style="max-width: 150px;" />
                        </div>
                        <div class="text-danger small field-error" id="error-AnhChinh"></div>
                    </div>

                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary px-4 me-2"><i class="bi bi-save"></i> <span id="btnSubmitText">Lưu</span></button>
                        <button type="button" class="btn btn-secondary px-4" id="btnCancelForm"><i class="bi bi-x-circle"></i> Hủy</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @*
    KHÔNG thêm các script CDN jQuery, Bootstrap, SweetAlert2 ở đây.
    Chúng phải được tải MỘT LẦN DUY NHẤT trong _LayoutAdmin.cshtml.
    Đảm bảo dòng `<script src="~/LayoutAdmin/lib/jquery/dist/jquery.js"></script>` đã bị XÓA trong Layout.
    *@

    <script>
        // --- ĐỊNH NGHĨA HÀM (BÊN NGOÀI DOCUMENT.READY) ---
        const apiUrl = '/api/SanPhamApi';
        let allProducts = []; // Dữ liệu sẽ được load bằng AJAX

        // Hàm tiện ích hiển thị thông báo chung (cho bảng hoặc form)
        function showAlert(selector, message, isSuccess) {
            const alertElement = $(selector);
            alertElement.html(`<div class="alert alert-${isSuccess ? 'success' : 'danger'} alert-dismissible fade show" role="alert">
                                ${message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                              </div>`)
                        .removeClass('d-none');
             // Tự động ẩn sau 5 giây cho thông báo thành công
            if (isSuccess) {
                setTimeout(() => {
                    alertElement.find('.alert').alert('close');
                }, 5000);
            }
        }

        // Xóa tất cả các loại lỗi trên form
        function clearFormErrors() {
            $('.field-error').text('');
            $('.form-control, .form-select').removeClass('is-invalid');
            $('#formAlertMessage').empty().addClass('d-none'); // Ẩn và xóa thông báo lỗi chung của form
        }

        // Reset form về trạng thái ban đầu (Thêm mới) và ẩn đi
        function resetAndHideForm() {
            $('#productForm')[0].reset();
            $('#MaSP').val(0);
            $('#formTitle').text('Thêm mới sản phẩm');
            $('#btnSubmitText').text('Lưu'); // Đổi thành Lưu cho cả thêm/sửa
            $('#previewImage').attr('src', '');
            $('#anhPreviewContainer').hide();
            $('#AnhChinhHienTai').val('');
            clearFormErrors();
            $('#productFormCard').slideUp(); // Ẩn form đi
        }

        // Hiển thị form và cuộn tới đó
        function showAndScrollToForm() {
             $('#productFormCard').slideDown();
             $('html, body').animate({
                 scrollTop: $("#productFormCard").offset().top - 70 // trừ đi chiều cao navbar nếu cần
             }, 500);
        }

        // Hiển thị danh sách sản phẩm vào bảng
        function renderTable(products) {
            const tableBody = $('#tableBody');
            tableBody.empty();
            if (!products || products.length === 0) {
                tableBody.html('<tr><td colspan="7" class="text-center text-info">Không tìm thấy sản phẩm nào.</td></tr>');
                return;
            }

            products.forEach(product => {
                let imgHtml = '(Không có ảnh)';
                // Ưu tiên ảnh chính, nếu không có thì lấy ảnh đầu tiên trong danh sách ảnh (nếu có)
                let imageUrl = product.anhChinh;

                if (imageUrl) {
                    // Kiểm tra xem URL có cần thêm tiền tố không (nếu API không trả về URL đầy đủ)
                    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                         imageUrl = '/' + imageUrl; // Giả sử ảnh nằm trong wwwroot
                    }
                    imgHtml = `<img src="${imageUrl}" alt="Ảnh SP ${product.tenSP}" style="max-width:50px; max-height:50px; object-fit: cover;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';" /><span style="display:none;">(Ảnh lỗi)</span>`;
                }


                tableBody.append(`
                    <tr data-id="${product.maSP}">
                        <td>${product.maSP}</td>
                        <td class="text-start">${product.tenSP}</td>
                        <td>${product.tenLoaiTui || 'N/A'}</td>
                        <td>${product.tenThuongHieu || 'N/A'}</td>
                        <td>${product.tenChatLieu || 'N/A'}</td>
                        <td>${imgHtml}</td>
                        <td>
                            <button class="btn btn-info btn-sm btnViewDetail" data-id="${product.maSP}" title="Xem chi tiết"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-warning btn-sm btnEdit" data-id="${product.maSP}" title="Sửa"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger btn-sm btnDelete" data-id="${product.maSP}" title="Xoá"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }

        // Tải danh sách sản phẩm từ API
        function loadProducts() {
            const tableBody = $('#tableBody');
            tableBody.html('<tr><td colspan="7" class="text-center text-muted"><div class="spinner-border spinner-border-sm" role="status"></div> Đang tải...</td></tr>');
            $('#tableAlertMessage').empty().addClass('d-none'); // Xóa thông báo cũ

            $.ajax({
                url: apiUrl,
                method: 'GET',
                data: { tenSp: $("#searchInput").val() || '' }, // Gửi luôn từ khóa tìm kiếm
                success: function (response) {
                    // API của bạn trả về BaseResponse<List<DTO>> hoặc List<DTO> trực tiếp?
                    // Giả sử API trả về BaseResponse (có status và data)
                    if (response && response.status === 'success') {
                         allProducts = response.data || [];
                         renderTable(allProducts);
                     } else if ($.isArray(response)) {
                         // Nếu API trả về List<DTO> trực tiếp
                         allProducts = response;
                         renderTable(allProducts);
                    }
                     else {
                         showAlert('#tableAlertMessage', response.message || 'Lỗi tải dữ liệu sản phẩm.', false);
                         tableBody.html('<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>');
                    }
                },
                error: function (xhr) {
                     showAlert('#tableAlertMessage', `Lỗi kết nối máy chủ (${xhr.status}): ${xhr.statusText}`, false);
                     tableBody.html('<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối máy chủ.</td></tr>');
                }
            });
        }

        // Điền dữ liệu sản phẩm vào form để chỉnh sửa
        function fillFormForEdit(product) {
            clearFormErrors();
            $('#MaSP').val(product.maSP);
            $('#TenSP').val(product.tenSP);
            $('#MoTaChiTiet').val(product.moTaChiTiet);
            $('#MetaTitle').val(product.metaTitle);
            $('#MetaDescription').val(product.metaDescription);
            $('#MaLoaiTui').val(String(product.maLoaiTui));
            $('#MaThuongHieu').val(String(product.maThuongHieu));
            $('#MaChatLieu').val(String(product.maChatLieu));

            // Hiển thị ảnh hiện tại nếu có
            if (product.anhChinh) {
                let imageUrl = product.anhChinh;
                 if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                     imageUrl = '/' + imageUrl;
                 }
                $('#previewImage').attr('src', imageUrl);
                $('#anhPreviewContainer').show();
                $('#AnhChinhHienTai').val(product.anhChinh); // Lưu lại đường dẫn cũ
            } else {
                $('#previewImage').attr('src', '');
                $('#anhPreviewContainer').hide();
                $('#AnhChinhHienTai').val('');
            }
            $('#formTitle').text(`Cập nhật sản phẩm: ${product.tenSP} (Mã: ${product.maSP})`);
            $('#btnSubmitText').text('Cập nhật'); // Đổi chữ nút submit
            showAndScrollToForm(); // Hiển thị form và cuộn tới
        }

        // Xử lý và hiển thị lỗi validation từ server (đọc từ mảng lỗi)
        function handleValidationErrors(errors) {
            let errorMessagesHtml = '';
            // errors là MẢNG [ {field: "...", message: "..."} ] từ ValidateModelAttribute

            errors.forEach(function(error) {
                let fieldName = error.field || error.fieldName || error.FieldName;
                let errorMessage = error.message || error.errorMessage || error.ErrorMessage;

                if (!fieldName) {
                    console.warn("Lỗi validation không có tên trường:", error);
                    errorMessagesHtml += `<li>Lỗi không xác định: ${errorMessage || JSON.stringify(error)}</li>`;
                    return;
                }

                 // Hiển thị lỗi ngay dưới trường input/select
                 // Chuẩn hóa tên: MaLoaiTui -> error-MaLoaiTui
                let errorFieldId = "error-" + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                var errorElement = $(errorFieldId);
                if (errorElement.length) {
                    errorElement.text(errorMessage);
                    // Thêm class is-invalid vào input/select phía trước div lỗi
                    errorElement.prev('.form-control, .form-select').addClass('is-invalid');
                } else {
                    // Nếu không tìm thấy chỗ hiển thị lỗi cụ thể, ghi vào danh sách chung
                     console.warn(`Không tìm thấy phần tử hiển thị lỗi: #${errorFieldId}`);
                     errorMessagesHtml += `<li><strong>${fieldName}:</strong> ${errorMessage}</li>`;
                }
            });

            // Hiển thị thông báo lỗi chung trên đầu form nếu có lỗi không hiển thị được ở từng field
            if(errorMessagesHtml) {
                 showAlert('#formAlertMessage', 'Vui lòng kiểm tra lại dữ liệu:<ul class="mb-0">' + errorMessagesHtml + '</ul>', false);
            } else {
                 // Nếu tất cả lỗi đã hiển thị dưới field, chỉ cần 1 thông báo chung đơn giản
                 showAlert('#formAlertMessage', 'Vui lòng sửa các lỗi được đánh dấu bên dưới.', false);
            }
        }


        // --- SỰ KIỆN (BÊN TRONG DOCUMENT.READY) ---
        $(document).ready(function () {

            // 1. Nhấn nút "Thêm mới" -> Hiển thị form trống
            $('#btnAddNewProduct').on('click', function() {
                resetAndHideForm(); // Đảm bảo form sạch sẽ
                $('#formTitle').text('Thêm mới sản phẩm');
                $('#btnSubmitText').text('Lưu');
                showAndScrollToForm();
            });

            // 2. Nhấn nút "Hủy" trên form -> Reset và ẩn form
            $('#btnCancelForm').on('click', resetAndHideForm);

            // 3. Xem trước ảnh khi chọn file mới
            $('#AnhChinh').on('change', function () {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#previewImage').attr('src', e.target.result);
                        $('#anhPreviewContainer').show();
                    };
                    reader.readAsDataURL(this.files[0]);
                } else {
                     // Nếu hủy chọn file, kiểm tra xem có ảnh cũ không để hiển thị lại
                     const anhCu = $('#AnhChinhHienTai').val();
                     if (anhCu) {
                         let imageUrl = anhCu;
                         if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                         }
                         $('#previewImage').attr('src', imageUrl);
                         $('#anhPreviewContainer').show();
                     } else {
                        $('#previewImage').attr('src', '');
                        $('#anhPreviewContainer').hide();
                     }
                }
            });

            // 4. Submit form (Thêm mới / Cập nhật) - Dùng Event Delegation
            $(document).on('submit', '#productForm', function (e) {
                e.preventDefault();
                clearFormErrors();

                const formData = new FormData(this);
                const maSP = $('#MaSP').val(); // Lấy MaSP từ hidden input
                const isNew = (maSP == 0); // Kiểm tra là thêm mới hay cập nhật
                const url = isNew ? apiUrl : `${apiUrl}/${maSP}`;
                const method = isNew ? 'POST' : 'PUT';

                // Log để kiểm tra file trước khi gửi
                console.log("Chuẩn bị gửi FormData. File:", formData.get("AnhChinh"));

                // Hiển thị loading (ví dụ: vô hiệu hóa nút submit)
                const submitButton = $(this).find('button[type="submit"]');
                const originalButtonText = $('#btnSubmitText').text();
                submitButton.prop('disabled', true);
                $('#btnSubmitText').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang lưu...');


                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false, // Bắt buộc khi gửi FormData
                    contentType: false, // Bắt buộc khi gửi FormData
                    success: function (response) {
                        // Giả sử API trả về BaseResponse { status: 'success'/'error', message: '...', data: ... }
                        if (response && response.status === 'success') {
                            showAlert('#tableAlertMessage', response.message || (isNew ? 'Thêm sản phẩm thành công!' : 'Cập nhật sản phẩm thành công!'), true);
                            resetAndHideForm();
                            loadProducts(); // Tải lại bảng dữ liệu
                        } else {
                            // Lỗi nghiệp vụ từ API (status 200 nhưng báo lỗi)
                            showAlert('#formAlertMessage', response.message || 'Có lỗi xảy ra trong quá trình xử lý.', false);
                        }
                    },
                    error: function (xhr) {
                        // Xử lý lỗi HTTP (400, 500, etc.)
                        if (xhr.responseJSON) {
                            var errorResponse = xhr.responseJSON;
                            // Lỗi Validation (từ ValidateModelAttribute - trả về BaseResponse có errors)
                            if (errorResponse.errors && Array.isArray(errorResponse.errors)) {
                                handleValidationErrors(errorResponse.errors);
                            }
                            // Lỗi nghiệp vụ khác trả về 400 (BaseResponse có message)
                            else if (errorResponse.message) {
                                showAlert('#formAlertMessage', errorResponse.message, false);
                            }
                            // Lỗi không rõ cấu trúc
                            else {
                                showAlert('#formAlertMessage', 'Lỗi không xác định từ server.', false);
                                console.error("Lỗi AJAX không rõ cấu trúc:", errorResponse);
                            }
                        } else {
                            // Lỗi không phải JSON (VD: 500 Internal Server Error không có body JSON)
                            showAlert('#formAlertMessage', `Lỗi ${xhr.status}: ${xhr.statusText}. Không thể kết nối hoặc server gặp sự cố.`, false);
                            console.error("Lỗi AJAX:", xhr);
                        }
                    },
                    complete: function() {
                         // Khôi phục lại nút submit sau khi hoàn thành (thành công hoặc lỗi)
                         submitButton.prop('disabled', false);
                         $('#btnSubmitText').text(originalButtonText);
                    }
                });
            });

            // 5. Nhấn nút "Sửa" trên bảng -> Tải dữ liệu và hiển thị form
            $('#tableBody').on('click', '.btnEdit', function () {
                const id = $(this).data('id');
                resetAndHideForm(); // Reset trước khi tải dữ liệu mới
                $('#tableAlertMessage').empty().addClass('d-none'); // Xóa thông báo bảng nếu có

                 // Hiển thị loading tạm thời trên form
                $('#formTitle').text('Đang tải dữ liệu...');
                showAndScrollToForm();

                $.ajax({
                    url: `${apiUrl}/${id}`,
                    method: 'GET',
                    success: function (response) {
                         // Giả sử API trả về BaseResponse { status: 'success', data: product }
                        if (response && response.status === 'success' && response.data) {
                            fillFormForEdit(response.data);
                        } else {
                            showAlert('#tableAlertMessage', response.message || 'Không tìm thấy dữ liệu sản phẩm.', false);
                            resetAndHideForm(); // Ẩn form nếu lỗi
                        }
                    },
                    error: function (xhr) {
                        showAlert('#tableAlertMessage', `Lỗi ${xhr.status} khi tải chi tiết sản phẩm.`, false);
                        resetAndHideForm(); // Ẩn form nếu lỗi
                    }
                });
            });

            // 6. Nhấn nút "Xóa" trên bảng
            $('#tableBody').on('click', '.btnDelete', function () {
                const id = $(this).data('id');
                const row = $(this).closest('tr');
                const tenSP = row.find('td:eq(1)').text(); // Lấy tên SP từ cột thứ 2

                Swal.fire({
                    title: 'Xác nhận xóa?',
                    html: `Bạn có chắc muốn xóa sản phẩm <strong>${tenSP}</strong> (Mã: ${id})?<br/>Thao tác này không thể hoàn tác!`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Đồng ý xóa',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            method: 'DELETE',
                            success: function (response) {
                                if (response && response.status === 'success') {
                                    Swal.fire('Đã xóa!', response.message || 'Sản phẩm đã được xóa thành công.', 'success');
                                    // Xóa hàng khỏi bảng một cách mượt mà
                                    row.fadeOut(500, function() {
                                        $(this).remove();
                                        // Kiểm tra xem bảng còn hàng nào không
                                        if ($('#tableBody tr').length === 0) {
                                             loadProducts(); // Tải lại nếu hết sản phẩm
                                        }
                                    });
                                } else {
                                    Swal.fire('Lỗi!', response.message || 'Không thể xóa sản phẩm.', 'error');
                                }
                            },
                            error: function (xhr) {
                                Swal.fire('Lỗi!', `Lỗi ${xhr.status} khi xóa sản phẩm.`, 'error');
                            }
                        });
                    }
                });
            });

            // 7. Tìm kiếm (khi nhấn nút hoặc Enter)
            function performSearch() {
                loadProducts(); // Hàm loadProducts đã lấy giá trị từ searchInput
            }

            $('#btnSearch').on('click', performSearch);
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) { // 13 là mã phím Enter
                    performSearch();
                }
            });

            // 8. Nhấn nút "Xem chi tiết"
            $('#tableBody').on('click', '.btnViewDetail', function () {
                const id = $(this).data('id');
                window.location.href = `/Admin/SanPham/Detail/${id}`; // Chuyển trang
            });

            // --- KHỞI TẠO ---
            loadProducts(); // Tải danh sách sản phẩm ban đầu khi trang sẵn sàng
        });
    </script>
}