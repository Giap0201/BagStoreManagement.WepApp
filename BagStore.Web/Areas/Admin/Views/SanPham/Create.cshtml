@model BagStore.Web.Models.DTOs.SanPhams.SanPhamRequestDto
@{
    ViewData["Title"] = "Thêm mới sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-white border-0 d-flex align-items-center pb-2">
        <i class="mdi mdi-plus-circle-outline text-primary fs-3 me-2"></i>
        <h4 class="text-primary mb-0 fw-semibold">Thêm mới sản phẩm</h4>
    </div>

    <div class="card-body pt-3">
        <div id="errorContainer" class="alert alert-danger d-none"></div>
        <form id="createForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label asp-for="TenSP" class="form-label"></label>
                <input asp-for="TenSP" class="form-control" />
                <span asp-validation-for="TenSP" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MoTaChiTiet" class="form-label"></label>
                <textarea asp-for="MoTaChiTiet" class="form-control" rows="3"></textarea>
                <span asp-validation-for="MoTaChiTiet" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MetaTitle" class="form-label"></label>
                <input asp-for="MetaTitle" class="form-control" />
                <span asp-validation-for="MetaTitle" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MetaDescription" class="form-label"></label>
                <textarea asp-for="MetaDescription" class="form-control" rows="2"></textarea>
                <span asp-validation-for="MetaDescription" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MaLoaiTui" class="form-label"></label>
                <select asp-for="MaLoaiTui" class="form-select" id="inputLoaiTui">
                    <option value="">Chọn loại túi</option>
                </select>
                <span asp-validation-for="MaLoaiTui" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MaThuongHieu" class="form-label"></label>
                <select asp-for="MaThuongHieu" class="form-select" id="inputThuongHieu">
                    <option value="">Chọn thương hiệu</option>
                </select>
                <span asp-validation-for="MaThuongHieu" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MaChatLieu" class="form-label"></label>
                <select asp-for="MaChatLieu" class="form-select" id="inputChatLieu">
                    <option value="">Chọn chất liệu</option>
                </select>
                <span asp-validation-for="MaChatLieu" class="invalid-feedback"></span>
            </div>

            <div class="mb-3">
                <label asp-for="AnhChinh" class="form-label"></label>
                <input asp-for="AnhChinh" class="form-control" type="file" accept="image/*" id="inputAnhChinh" />
                <span asp-validation-for="AnhChinh" class="invalid-feedback"></span>
            </div>

            <div class="text-end">
                <a href="/Admin/SanPham" class="btn btn-secondary">Quay lại</a>
                <button type="submit" class="btn btn-primary">Lưu</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $(document).ready(function () {
            const apiUrl = '/api/SanPhamApi';
            const form = $('#createForm');
            const errorContainer = $('#errorContainer');
            const inputLoaiTui = $('#inputLoaiTui');
            const inputThuongHieu = $('#inputThuongHieu');
            const inputChatLieu = $('#inputChatLieu');
            const inputAnhChinh = $('#inputAnhChinh');

            // Load dropdowns
            $.ajax({
                url: '/api/DanhMucLoaiTuiApi',
                method: 'GET',
                success: function (res) {
                    if (res.status.toLowerCase() === 'success') {
                        inputLoaiTui.empty().append('<option value="">Chọn loại túi</option>');
                        res.data.forEach(c => inputLoaiTui.append(`<option value="${c.maLoaiTui}">${c.tenLoaiTui}</option>`));
                    }
                }
            });
            $.ajax({
                url: '/api/ThuongHieuApi',
                method: 'GET',
                success: function (res) {
                    if (res.status.toLowerCase() === 'success') {
                        inputThuongHieu.empty().append('<option value="">Chọn thương hiệu</option>');
                        res.data.forEach(c => inputThuongHieu.append(`<option value="${c.maThuongHieu}">${c.tenThuongHieu}</option>`));
                    }
                }
            });
            $.ajax({
                url: '/api/ChatLieuApi',
                method: 'GET',
                success: function (res) {
                    if (res.status.toLowerCase() === 'success') {
                        inputChatLieu.empty().append('<option value="">Chọn chất liệu</option>');
                        res.data.forEach(c => inputChatLieu.append(`<option value="${c.maChatLieu}">${c.tenChatLieu}</option>`));
                    }
                }
            });

            // Xử lý submit form
            form.on('submit', function (e) {
                e.preventDefault();
                if (!form.valid()) return; // Ngăn gửi nếu validate client-side thất bại

                errorContainer.addClass('d-none').empty();

                const formData = new FormData();
                formData.append('MaSanPham', 0);
                formData.append('TenSP', $('#TenSP').val().trim());
                formData.append('MoTaChiTiet', $('#MoTaChiTiet').val().trim());
                formData.append('MetaTitle', $('#MetaTitle').val().trim());
                formData.append('MetaDescription', $('#MetaDescription').val().trim());
                formData.append('MaLoaiTui', inputLoaiTui.val());
                formData.append('MaThuongHieu', inputThuongHieu.val());
                formData.append('MaChatLieu', inputChatLieu.val());
                if (inputAnhChinh[0].files[0]) formData.append('AnhChinh', inputAnhChinh[0].files[0]);

                $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function (res) {
                        if (res.status.toLowerCase() === 'success') {
                            Swal.fire('Thành công!', res.message || 'Thêm mới thành công', 'success').then(() => {
                                window.location.href = '/Admin/SanPham';
                            });
                        } else {
                            showError(res);
                        }
                    },
                    error: function (xhr) {
                        showError(xhr.responseJSON || { message: 'Có lỗi xảy ra.' });
                    }
                });
            });

            // Hàm hiển thị lỗi server-side
            function showError(response) {
                errorContainer.addClass('d-none').empty();
                let html = response.message || 'Có lỗi xảy ra';
                if (response.errors && response.errors.length) {
                    html += '<ul>' + response.errors.map(e => `<li>${e.message}</li>`).join('') + '</ul>';
                }
                errorContainer.removeClass('d-none').html(html);
                Swal.fire({ title: 'Lỗi!', html: html, icon: 'error' });
            }
        });
    </script>
}