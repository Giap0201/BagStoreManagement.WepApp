@model BagStore.Web.Models.ViewModels.SanPhamDetailViewModel

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container mt-4">
    <h3 class="text-primary mb-3">
        <i class="bi bi-info-circle"></i> Chi tiết sản phẩm
    </h3>

    <!-- Thông tin sản phẩm -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Thông tin sản phẩm</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4 text-center">
                    <img id="AnhChinh" src="" class="img-thumbnail" style="max-width:200px; object-fit:cover;" alt="Ảnh sản phẩm" />
                </div>
                <div class="col-md-8">
                    <table class="table table-borderless">
                        <tbody>
                            <tr><th>Mã SP:</th><td id="MaSP"></td></tr>
                            <tr><th>Tên sản phẩm:</th><td id="TenSP"></td></tr>
                            <tr><th>Loại túi:</th><td id="TenLoaiTui"></td></tr>
                            <tr><th>Thương hiệu:</th><td id="TenThuongHieu"></td></tr>
                            <tr><th>Chất liệu:</th><td id="TenChatLieu"></td></tr>
                            <tr><th>Mô tả chi tiết:</th><td id="MoTaChiTiet"></td></tr>
                            <tr><th>Meta Title:</th><td id="MetaTitle"></td></tr>
                            <tr><th>Meta Description:</th><td id="MetaDescription"></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Ảnh sản phẩm -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Ảnh sản phẩm</h5>
        </div>
        <div class="card-body">
            <div id="anhSanPhamList" class="d-flex flex-wrap gap-3 justify-content-start">
                <div class="text-muted">Đang tải ảnh...</div>
            </div>
        </div>
    </div>

    <!-- Chi tiết sản phẩm (biến thể) -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Chi tiết sản phẩm</h5>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>Mã chi tiết</th>
                        <th>Màu sắc</th>
                        <th>Kích thước</th>
                        <th>Số lượng tồn</th>
                        <th>Giá bán</th>
                    </tr>
                </thead>
                <tbody id="chiTietSanPhamTableBody">
                    <tr><td colspan="5" class="text-muted">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-end">
        <a href="/Admin/SanPham" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Quay lại</a>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const maSP = @Model.SanPham.MaSP;
            const apiBase = `/api/sanpham/${maSP}`;

            // --- 1️⃣ Lấy thông tin sản phẩm chính ---
            function loadSanPhamInfo() {
                $.ajax({
                    url: `/api/SanPhamApi/${maSP}`,
                    method: 'GET',
                    success: function (res) {
                        if (res.status === 'success' && res.data) {
                            const sp = res.data;
                            $('#MaSP').text(sp.maSP);
                            $('#TenSP').text(sp.tenSP);
                            $('#TenLoaiTui').text(sp.tenLoaiTui || 'N/A');
                            $('#TenThuongHieu').text(sp.tenThuongHieu || 'N/A');
                            $('#TenChatLieu').text(sp.tenChatLieu || 'N/A');
                            $('#MoTaChiTiet').text(sp.moTaChiTiet);
                            $('#MetaTitle').text(sp.metaTitle || '');
                            $('#MetaDescription').text(sp.metaDescription || '');
                            $('#AnhChinh').attr('src', sp.anhChinh || '/images/placeholder.png');
                        } else {
                            Swal.fire('Lỗi', 'Không tải được thông tin sản phẩm.', 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Lỗi', 'Không thể kết nối máy chủ.', 'error');
                    }
                });
            }

            // --- 2️⃣ Lấy danh sách ảnh sản phẩm ---
            function loadAnhSanPham() {
                $.ajax({
                    url: `${apiBase}/AnhSanPhamApi`,
                    method: 'GET',
                    success: function (res) {
                        const container = $('#anhSanPhamList');
                        container.empty();

                        if (res.status === 'success' && res.data.length > 0) {
                            res.data.forEach(a => {
                                const html = `
                                    <div class="card p-2 text-center" style="width:120px;">
                                        <img src="${a.duongDanAnh}" class="img-thumbnail" alt="Ảnh SP">
                                        <div class="small text-muted mt-1">${a.tenAnh || ''}</div>
                                    </div>`;
                                container.append(html);
                            });
                        } else {
                            container.html('<div class="text-muted">Không có ảnh nào.</div>');
                        }
                    },
                    error: function () {
                        $('#anhSanPhamList').html('<div class="text-danger">Lỗi tải ảnh sản phẩm.</div>');
                    }
                });
            }

            // --- 3️⃣ Lấy danh sách chi tiết sản phẩm ---
            function loadChiTietSanPham() {
                $.ajax({
                    url: `${apiBase}/ChiTietSanPhamApi`,
                    method: 'GET',
                    success: function (res) {
                        const tbody = $('#chiTietSanPhamTableBody');
                        tbody.empty();

                        if (res.status === 'success' && res.data.length > 0) {
                            res.data.forEach(ct => {
                                tbody.append(`
                                    <tr>
                                        <td>${ct.maChiTietSP}</td>
                                        <td>${ct.mauSac || 'N/A'}</td>
                                        <td>${ct.kichThuoc || 'N/A'}</td>
                                        <td>${ct.soLuongTon}</td>
                                        <td>${ct.giaBan.toLocaleString()} đ</td>
                                    </tr>
                                `);
                            });
                        } else {
                            tbody.html('<tr><td colspan="5" class="text-muted">Không có chi tiết sản phẩm nào.</td></tr>');
                        }
                    },
                    error: function () {
                        $('#chiTietSanPhamTableBody').html('<tr><td colspan="5" class="text-danger">Lỗi tải dữ liệu chi tiết sản phẩm.</td></tr>');
                    }
                });
            }

            // Gọi tất cả khi trang load
            loadSanPhamInfo();
            loadAnhSanPham();
            loadChiTietSanPham();
        });
    </script>
}
