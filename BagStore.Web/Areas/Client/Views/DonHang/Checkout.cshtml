@{
    Layout = "~/Views/Shared/_ClientLayout.cshtml";
    ViewData["Title"] = "Đơn hàng";
}

<!-- include jQuery & SweetAlert2 (CDN) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-fluid bg-secondary mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
        <h1 class="font-weight-semi-bold text-uppercase mb-3">CHECKOUT</h1>
        <div class="d-inline-flex">
            <p class="m-0"><a href="">Home</a></p>
        </div>
    </div>
</div>

<form id="checkoutForm">
    <div>
        <label>Địa chỉ giao hàng</label><br />
        <input type="text" id="diaChi" name="DiaChiGiaoHang" class="form-control" required />
    </div>

    <div>
        <label>Phương thức thanh toán</label><br />
        <select id="pttt" name="PhuongThucThanhToan" class="form-control">
            <option value="COD">COD</option>
            <option value="Chuyển khoản">Chuyển khoản</option>
        </select>
    </div>

    <h4>Sản phẩm</h4>
    <!-- Giả sử bạn render sản phẩm/cart bằng server hoặc JS; ví dụ static cho demo -->
    <div id="cartItems">
        <!-- item mẫu: data attributes cho maChiTietSP, giaBan -->
        <div class="cart-row" data-machitietsp="3" data-giaban="250000">
            <span>Tên sản phẩm A</span>
            <input type="number" class="qty" value="1" min="1" />
        </div>
        <div class="cart-row" data-machitietsp="4" data-giaban="300000">
            <span>Tên sản phẩm B</span>
            <input type="number" class="qty" value="1" min="1" />
        </div>
    </div>

    <button id="btnOrder" type="button" class="btn btn-primary mt-3">Đặt hàng</button>
</form>

<script>
    $(function() {
        $('#btnOrder').click(async function () {
            // Build DTO từ form
            const chiTietDonHangs = [];
            $('#cartItems .cart-row').each(function () {
                const ma = parseInt($(this).data('machitietsp'));
                const gia = parseFloat($(this).data('giaban'));
                const soLuong = parseInt($(this).find('.qty').val()) || 1;
                chiTietDonHangs.push({
                    MaChiTietSP: ma,
                    SoLuong: soLuong,
                    GiaBan: gia
                });
            });

            const dto = {
                MaKH: /* TODO: lấy user id server-side hoặc đặt 0 */ 2, // thay bằng user id thực
                DiaChiGiaoHang: $('#diaChi').val(),
                PhuongThucThanhToan: $('#pttt').val(),
                ChiTietDonHangs: chiTietDonHangs
            };

            // Xác nhận bằng SweetAlert
            const result = await Swal.fire({
                title: 'Xác nhận đặt hàng?',
                text: 'Bạn có chắc muốn đặt các sản phẩm này?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Đặt hàng',
                cancelButtonText: 'Hủy'
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/api/DonHangApi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });

                if (res.ok) {
                    const data = await res.json();
                    await Swal.fire('Thành công', 'Đơn hàng đã được tạo', 'success');
                    // Redirect tới trang danh sách đơn hàng client
                    window.location.href = '/Client/Orders/Index';
                } else {
                    // show lỗi chi tiết (server có thể trả text hoặc json)
                    const txt = await res.text();
                    await Swal.fire('Lỗi', txt, 'error');
                }
            } catch (err) {
                await Swal.fire('Lỗi', err.message || 'Lỗi mạng', 'error');
            }
        });
    });
</script>
