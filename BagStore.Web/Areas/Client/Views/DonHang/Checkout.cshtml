@{
    Layout = "~/Areas/Client/Views/LayoutShop/_LayoutShopNew.cshtml";
    ViewData["Title"] = "Thanh toán";

    var userId = ViewBag.UserId;
    string selectedItems = ViewBag.SelectedItems ?? "";
}
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-fluid bg-secondary mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
        <h1 class="font-weight-semi-bold text-uppercase mb-3">Thanh toán</h1>
        <div class="d-inline-flex">
            <p class="m-0"><a href="/">Trang chủ</a></p>
        </div>
    </div>
</div>

<div class="container mb-5">
    <form id="checkoutForm">
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Địa chỉ giao hàng</label>
                <input type="text" id="diaChi" name="DiaChiGiaoHang" class="form-control" placeholder="Nhập địa chỉ giao hàng" required />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Phương thức thanh toán</label>
                <select id="pttt" name="PhuongThucThanhToan" class="form-select">
                    <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                    <option value="Chuyển khoản">Chuyển khoản ngân hàng</option>
                    <option value="Ví điện tử">Ví điện tử</option>
                </select>
            </div>
        </div>
        <!-- ✅ Responsive Table -->
        <div class="table-responsive shadow-sm rounded-3">
            <table id="checkoutTable" class="table table-bordered align-middle text-center">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Màu sắc</th>
                        <th>Kích cỡ</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <th colspan="6" class="text-end">Tổng cộng</th>
                        <th id="tongTien" class="text-danger">0 ₫</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="text-center mt-4">
            <button id="btnOrder" type="button" class="btn btn-success px-4 py-2 fw-bold">Thanh toán</button>
        </div>
    </form>
</div>

<!-- CSS: sửa media queries -->
<style>
    @@media (max-width: 992px) {
        h1 .font-weight-semi-bold

    {
        font-size: 1.75rem;
    }

    #checkoutForm .form-label {
        font-size: 0.95rem;
    }

    #checkoutTable th,
    #checkoutTable td {
        font-size: 0.9rem;
        white-space: nowrap;
    }

    }

    @@media (max-width: 768px) {
        .container.mb-5

    {
        padding: 0 10px;
    }

    #checkoutTable {
        font-size: 0.85rem;
    }

        #checkoutTable img {
            width: 55px !important;
            height: 55px !important;
        }

    .table-responsive {
        border: 1px solid #dee2e6;
    }

    .btnOrder {
        width: 100%;
    }

    }

    @@media (max-width: 576px) {
        .d-flex.flex-column.align-items-center.justify-content-center

    {
        min-height: 200px !important;
    }

    h1.font-weight-semi-bold {
        font-size: 1.5rem;
        text-align: center;
    }

    #checkoutTable th,
    #checkoutTable td {
        padding: 0.5rem 0.3rem;
    }

    #checkoutForm .form-control,
    #checkoutForm .form-select {
        font-size: 0.9rem;
    }

    .text-end {
        text-align: right !important;
    }

    #tongTien {
        font-size: 1rem;
    }

    }
</style>

<script>
    // An toàn: serialize Razor values (nếu userId là số/string)
    const userId = @Html.Raw(Json.Serialize(userId));

    $(document).ready(async function () {
        let items = [];

        // Lấy selectedItems từ query string nếu có (format: "101:2,203:1")
        const queryParams = new URLSearchParams(window.location.search);
        const selectedItems = queryParams.get('selectedItems');

        // Helper: fetch chi tiết sp an toàn, xử lý cả trường hợp API trả { data : {...} }
        async function fetchProductDetail(maChiTietSP, maSanPham) {
            try {
                const res = await fetch(`/api/ChiTietSanPhamApi/${maChiTietSP}`);
                if (!res.ok) {
                    console.error(`Không lấy được chi tiết SP ${maChiTietSP}. Status:`, res.status);
                    return null;
                }
                const payload = await res.json();
                return payload.data || payload;
            } catch (err) {
                console.error("Lỗi fetch product detail:", err);
                return null;
            }
        }

        if (selectedItems) {
            // Trường hợp: chuyển từ Cart với query param "selectedItems=101:2,203:1"
            const pairs = selectedItems.split(',').map(p => p.trim()).filter(Boolean);
            for (const p of pairs) {
                const parts = p.split(':');
                const id = parseInt(parts[0]);
                const qty = parts.length > 1 ? parseInt(parts[1]) : 1;
                if (isNaN(id)) continue;

                const sp = await fetchProductDetail(id);
                if (!sp) {
                    // Nếu không lấy được 1 sp thì bỏ qua (không abort toàn bộ)
                    console.warn('Bỏ qua sản phẩm không tìm thấy:', id);
                    continue;
                }
                items.push({
                    maChiTietSP: id,
                    tenSP: sp.tenSanPham || sp.tenSP || 'Sản phẩm',
                    mauSac: sp.tenMauSac || sp.mauSac || '',
                    kichCo: sp.tenKichThuoc || sp.kichThuoc || '',
                    soLuong: qty,
                    giaBan: sp.giaBan || 0,
                    thanhTien: (sp.giaBan || 0) * qty,
                    hinhAnh: sp.duongDanAnh
                });
            }
        } else {
            // Lấy toàn bộ giỏ hàng user từ API
            try {
                const res = await fetch(`/api/Cart/${userId}`);
                if (!res.ok) {
                    Swal.fire('Lỗi', 'Giỏ hàng trống hoặc không tồn tại.', 'warning');
                    return;
                }
                const cart = await res.json();
                if (!cart || !cart.items) {
                    Swal.fire('Lỗi', 'Giỏ hàng rỗng.', 'warning');
                    return;
                }
                items = cart.items.map(x => ({
                    maChiTietSP: x.maChiTietSP,
                    hinhAnh: x.duongDanAnh,
                    tenSP: x.tenSP,
                    mauSac: x.mauSac,
                    kichCo: x.kichThuoc,
                    soLuong: x.soLuong,
                    giaBan: x.giaBan,
                    thanhTien: x.thanhTien || (x.giaBan * x.soLuong)
                }));
            } catch (err) {
                console.error('Lỗi khi lấy giỏ hàng:', err);
                Swal.fire('Lỗi', 'Không thể kết nối đến server để lấy giỏ hàng.', 'error');
                return;
            }
        }

        // Render table
        renderTable(items);

        // Xử lý click nút Thanh toán
        $('#btnOrder').off('click').on('click', async function () {
            if ($('#diaChi').val().trim() === "") {
                Swal.fire('Thiếu thông tin', 'Vui lòng nhập địa chỉ giao hàng', 'warning');
                return;
            }
            if (!items || items.length === 0) {
                Swal.fire('Lỗi', 'Không có sản phẩm để đặt hàng.', 'warning');
                return;
            }

            const dto = {
                DiaChiGiaoHang: $('#diaChi').val().trim(),
                PhuongThucThanhToan: $('#pttt').val(),
                ChiTietDonHang: items.map(x => ({
                    MaChiTietSanPham: x.maChiTietSP,
                    SoLuong: x.soLuong
                }))
            };

            const conf = await Swal.fire({
                title: 'Xác nhận đặt hàng?',
                text: 'Bạn chắc chắn muốn đặt đơn hàng này?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Đặt hàng',
                cancelButtonText: 'Hủy'
            });

            if (!conf.isConfirmed) return;

            try {
                const res = await fetch('/api/DonHangApi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đặt hàng thành công!',
                        text: 'Cảm ơn bạn đã mua hàng 💚',
                        confirmButtonText: 'Xem đơn hàng'
                    }).then(() => window.location.href = '/Client/DonHang/Index');
                } else {
                    const errText = await res.text();
                    Swal.fire('Lỗi', errText || 'Tạo đơn hàng thất bại', 'error');
                }
            } catch (err) {
                console.error('Lỗi khi tạo đơn:', err);
                Swal.fire('Lỗi', err.message || 'Không thể kết nối máy chủ', 'error');
            }
        });
    });

    // Hàm render table (giữ nguyên)
    function renderTable(items) {
        const tbody = $('#checkoutTable tbody');
        tbody.empty();
        let tongTien = 0;
        items.forEach(item => {
            tongTien += item.thanhTien || (item.giaBan * item.soLuong);
            tbody.append(`
                <tr>
                    <td><img src="${item.hinhAnh}" style="width:70px;height:70px;object-fit:cover;border-radius:5px"></td>
                    <td>${item.tenSP}</td>
                    <td>${item.mauSac}</td>
                    <td>${item.kichCo}</td>
                    <td>${item.soLuong}</td>
                    <td>${(item.giaBan || 0).toLocaleString('vi-VN')} ₫</td>
                    <td>${((item.thanhTien || (item.giaBan * item.soLuong)) || 0).toLocaleString('vi-VN')} ₫</td>
                </tr>
            `);
        });
        $('#tongTien').text((tongTien || 0).toLocaleString('vi-VN') + ' ₫');
    }
</script>



  