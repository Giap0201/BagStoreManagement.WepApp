@model BagStore.Web.Areas.Client.Models.ProductDetailViewModel
@{
    Layout = "~/Areas/Client/Views/LayoutShop/_LayoutShopNew.cshtml";
    ViewData["Title"] = "Thanh toán";
}

<div class="container py-5">
    <div class="row">
        <!-- Hình ảnh -->
        <div class="col-md-6">
            <div class="border mb-3"
                style="min-height: 600px; height: 600px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; padding: 20px; position: relative; overflow: hidden;">
                <img src="@(Model.Images.FirstOrDefault()?.DuongDan ?? "/uploads/no-image.png")"
                    class="rounded main-product-image" alt="@Model.Product?.TenSP"
                    style="height: 550px; width: auto; max-width: 100%; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in;" />
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3">
                @foreach (var img in Model.Images)
                {
                    <div style="width: 90px; height: 90px; overflow: hidden; border: 2px solid #dee2e6; border-radius: 6px; padding: 5px; cursor: pointer; transition: border-color 0.2s ease;"
                        onclick="changeMainImage('@img.DuongDan')" onmouseover="this.style.borderColor='#007bff'"
                        onmouseout="this.style.borderColor='#dee2e6'">
                        <img src="@img.DuongDan" style="width: 100%; height: 100%; object-fit: contain;" alt="Thumbnail" />
                    </div>
                }
            </div>
        </div>

        <!-- Thông tin -->
        <div class="col-md-6">
            <h2 class="fw-bold mb-3">@Model.Product?.TenSP</h2>
            <p class="text-muted mb-1">Mã sản phẩm: @Model.Product?.MaSP</p>
            <h4 class="text-danger mb-3">
                @(Model.Variant?.GiaBan.ToString("N0") ?? "—") ₫
            </h4>

            <p><strong>Chất liệu:</strong> @Model.Product?.ChatLieu?.TenChatLieu</p>
            <p><strong>Thương hiệu:</strong> @Model.Product?.ThuongHieu?.TenThuongHieu</p>
            <p><strong>Loại túi:</strong> @Model.Product?.DanhMucLoaiTui?.TenLoaiTui</p>

            <div class="mb-4">
                <a href="#" class="btn btn-primary btn-lg btn-add-to-cart" data-ma-sp="@Model.Product?.MaSP">
                    <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                </a>
                <a href="#"
                   class="btn btn-primary btn-lg btn-buy-now"
                   data-ma-sp="@Model.Product?.MaSP"
                   style="color:#C1847C; border:1px solid #C1847C; background-color:white;"
                   onmouseover="this.style.backgroundColor='#C1847C'; this.style.color='white';"
                   onmouseout="this.style.backgroundColor='white'; this.style.color='#C1847C';">
                    Mua Ngay
                </a>

            </div>
        </div>
    </div>

    <!-- Mô tả -->
    <div class="row mt-5">
        <div class="col-12">
            <h4 class="border-bottom pb-2 mb-3">Mô tả sản phẩm</h4>
            <p>@Html.Raw(Model.Product?.MoTaChiTiet ?? "Chưa có mô tả.")</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function changeMainImage(imageUrl) {
            $('.main-product-image').attr('src', imageUrl);
        }

        // Zoom effect khi hover vào ảnh chính
        $(document).on('mouseenter', '.main-product-image', function () {
            $(this).css('transform', 'scale(1.1)');
        }).on('mouseleave', '.main-product-image', function () {
            $(this).css('transform', 'scale(1)');
        });

        $(document).ready(function () {
            // ✅ Xử lý button "Thêm vào giỏ"
            $('.btn-add-to-cart').on('click', function (e) {
                e.preventDefault();
                const maSP = $(this).data('ma-sp');
                if (!maSP) return;

                openAddToCartModal(maSP);
            });

               // ✅ Xử lý button "Mua Ngay"
        $('.btn-buy-now').on('click', function (e) {
            e.preventDefault();
            const maSP = $(this).data('ma-sp');
            if (!maSP) return;

            openBuyNowModal(maSP);
        });
                function openBuyNowModal(maSP) {
            // Hiển thị modal "Mua ngay"
            $('#buyNowModal').modal('show');

            // Hiển thị trạng thái loading trong modal
            $('#buyNowProductInfo').html('<div class="text-center py-3"><div class="spinner-border"></div></div>');
            $('#buyNowMauSac, #buyNowKichThuoc').empty().append('<option value="">Đang tải...</option>');

            // Gọi API lấy thông tin sản phẩm
            $.get('/Client/Shop/GetProductOptions', { maSP: maSP })
                .done(function (data) {
                    const imgUrl = data.anhChinh
                        ? data.anhChinh.replace(/^wwwroot/, '').replace(/\\/g, '/')
                        : '/uploads/no-image.png';

                    // Hiển thị thông tin sản phẩm trong modal
                    $('#buyNowProductInfo').html(`
                        <div class="row align-items-center">
                            <div class="col-3">
                                <img src="${imgUrl}" class="img-fluid rounded" alt="${data.tenSP}" />
                            </div>
                            <div class="col-9">
                                <h5>${escapeHtml(data.tenSP)}</h5>
                                <p class="text-muted mb-0">Mã SP: ${data.maSP}</p>
                            </div>
                        </div>
                    `);

                    // Đổ danh sách màu sắc
                    const $mauSac = $('#buyNowMauSac');
                    $mauSac.empty().append('<option value="">-- Chọn màu sắc --</option>');
                    if (data.mauSacs && data.mauSacs.length > 0) {
                        data.mauSacs.forEach(function (mau) {
                            $mauSac.append(`<option value="${mau.maMauSac || mau.MaMauSac}">
                                ${mau.tenMauSac || mau.TenMauSac}
                            </option>`);
                        });
                    }

                    // Đổ danh sách kích thước
                    const $kichThuoc = $('#buyNowKichThuoc');
                    $kichThuoc.empty().append('<option value="">-- Chọn kích thước --</option>');
                    if (data.kichThuocs && data.kichThuocs.length > 0) {
                        data.kichThuocs.forEach(function (kt) {
                            $kichThuoc.append(`<option value="${kt.maKichThuoc || kt.MaKichThuoc}">
                                ${kt.tenKichThuoc || kt.TenKichThuoc}
                            </option>`);
                        });
                    }

                    // Lưu mã sản phẩm và đánh dấu chế độ
                    $('#buyNowMaSP').data('mode', 'buy-now');
                    $('#buyNowMaSP').val(maSP);
                })
                .fail(function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể tải thông tin sản phẩm!'
                    });
                    $('#buyNowModal').modal('hide');
                });
        }

       



            // ✅ Hàm mở modal chọn màu/kích thước
            function openAddToCartModal(maSP) {
                // Hiển thị modal loading
                $('#addToCartModal').modal('show');
                $('#modalProductInfo').html('<div class="text-center py-3"><div class="spinner-border"></div></div>');
                $('#modalMauSac, #modalKichThuoc').empty().append('<option value="">Đang tải...</option>');

                // Load thông tin sản phẩm
                $.get('/Client/Shop/GetProductOptions', { maSP: maSP })
                    .done(function (data) {
                        // Hiển thị thông tin sản phẩm
                        const imgUrl = data.anhChinh ? data.anhChinh.replace(/^wwwroot/, '').replace(/\\/g, '/') : '/uploads/no-image.png';
                        $('#modalProductInfo').html(`
                                                                                <div class="row align-items-center">
                                                                                    <div class="col-3">
                                                                                        <img src="${imgUrl}" class="img-fluid rounded" alt="${data.tenSP}" />
                                                                                    </div>
                                                                                    <div class="col-9">
                                                                                        <h5>${escapeHtml(data.tenSP)}</h5>
                                                                                        <p class="text-muted mb-0">Mã SP: ${data.maSP}</p>
                                                                                    </div>
                                                                                </div>
                                                                            `);

                        // Load màu sắc
                        const $mauSac = $('#modalMauSac');
                        $mauSac.empty().append('<option value="">-- Chọn màu sắc --</option>');
                        if (data.mauSacs && data.mauSacs.length > 0) {
                            data.mauSacs.forEach(function (mau) {
                                $mauSac.append(`<option value="${mau.maMauSac || mau.MaMauSac}">${mau.tenMauSac || mau.TenMauSac}</option>`);
                            });
                        }

                        // Load kích thước
                        const $kichThuoc = $('#modalKichThuoc');
                        $kichThuoc.empty().append('<option value="">-- Chọn kích thước --</option>');
                        if (data.kichThuocs && data.kichThuocs.length > 0) {
                            data.kichThuocs.forEach(function (kt) {
                                $kichThuoc.append(`<option value="${kt.maKichThuoc || kt.MaKichThuoc}">${kt.tenKichThuoc || kt.TenKichThuoc}</option>`);
                            });
                        }

                        // Lưu maSP vào modal
                        $('#modalMaSP').val(maSP);
                    })
                    .fail(function () {
                        Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Không thể tải thông tin sản phẩm!' });
                        $('#addToCartModal').modal('hide');
                    });
            }

            // ✅ Cập nhật số lượng tồn khi chọn màu/kích thước
            $('#modalMauSac, #modalKichThuoc').on('change', function () {
                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();

                if (!maSP || !maMauSac || !maKichThuoc) {
                    $('#modalSoLuongTon').text('-');
                    return;
                }

                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const soLuongTon = variant.soLuongTon || variant.SoLuongTon || 0;
                        $('#modalSoLuongTon').text(soLuongTon);
                        $('#modalSoLuong').attr('max', soLuongTon);
                    })
                    .fail(function () {
                        $('#modalSoLuongTon').text('-');
                    });
            });
            //xu li nut mua ngay
                    $('#formBuyNow').on('submit', function (e) {
            e.preventDefault();

            const maSP = $('#buyNowMaSP').val();
            const maMauSac = $('#buyNowMauSac').val();
            const maKichThuoc = $('#buyNowKichThuoc').val();
            const soLuong = parseInt($('#buyNowSoLuong').val()) || 1;

            if (!maMauSac || !maKichThuoc) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thiếu thông tin',
                    text: 'Vui lòng chọn màu sắc và kích thước!'
                });
                return;
            }

            // Lấy mã chi tiết sản phẩm
            $.get('/Client/Shop/GetVariant', {
                maSp: maSP,
                colorId: maMauSac,
                sizeId: maKichThuoc
            })
                .done(function (variant) {
                    const maChiTietSP = variant.maChiTietSP || variant.MaChiTietSP;
                    if (!maChiTietSP) {
                        Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Không tìm thấy biến thể sản phẩm này!' });
                        return;
                    }

                    // Tạo chuỗi params giống như đoạn trong hình
                    const params = `${maChiTietSP}:${soLuong}`;
                    console.log("🛒 Dữ liệu gửi đi:", params);

                    // Hiển thị hiệu ứng loading trước khi chuyển trang
                    Swal.fire({
                        title: 'Đang chuyển sang trang thanh toán...',
                        icon: 'info',
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // Chuyển sang trang Checkout
                    setTimeout(() => {
                        window.location.href = `/Client/DonHang/Checkout?selectedItems=${encodeURIComponent(params)}`;
                    }, 1000);
                })
                .fail(function () {
                    Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Không thể lấy thông tin sản phẩm!' });
                });
        });


            // ✅ Xử lý submit form thêm vào giỏ
            $('#formAddToCart').on('submit', function (e) {
                e.preventDefault();

                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();
                const soLuong = parseInt($('#modalSoLuong').val()) || 1;

                if (!maMauSac || !maKichThuoc) {
                    Swal.fire({ icon: 'warning', title: 'Thiếu thông tin', text: 'Vui lòng chọn màu sắc và kích thước!' });
                    return;
                }

                // Lấy MaChiTietSP
                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const maChiTietSP = variant.maChiTietSP || variant.MaChiTietSP;
                        if (!maChiTietSP) {
                            alert('Không tìm thấy biến thể sản phẩm này!');
                            return;
                        }

                        // Lấy MaKH từ user hiện tại (cần đăng nhập)
                        $.get('/Client/Shop/GetMaKH')
                            .done(function (response) {
                                if (!response || !response.maKH) {
                                    Swal.fire({ icon: 'warning', title: 'Yêu cầu đăng nhập', text: 'Vui lòng đăng nhập để thêm vào giỏ hàng!' }).then(() => {
                                        window.location.href = '/Client/Account/Login';
                                    });
                                    return;
                                }

                                // Gọi API thêm vào giỏ
                                $.ajax({
                                    url: '/api/Cart/add',
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        maKH: response.maKH,
                                        maChiTietSP: maChiTietSP,
                                        soLuong: soLuong
                                    }),
                                    success: function (result) {
                                        Swal.fire({ icon: 'success', title: 'Thành công', text: 'Đã thêm vào giỏ hàng thành công!', timer: 1500, showConfirmButton: false });
                                        $('#addToCartModal').modal('hide');
                                    },
                                    error: function (xhr) {
                                        if (xhr.status === 401) {
                                            Swal.fire({ icon: 'warning', title: 'Yêu cầu đăng nhập', text: 'Vui lòng đăng nhập để thêm vào giỏ hàng!' }).then(() => {
                                                window.location.href = '/Client/Account/Login';
                                            });
                                        } else {
                                            Swal.fire({ icon: 'error', title: 'Lỗi', text: (xhr.responseJSON && xhr.responseJSON.message) || 'Không thể thêm vào giỏ hàng!' });
                                        }
                                    }
                                });
                            })
                            .fail(function () {
                                Swal.fire({ icon: 'warning', title: 'Yêu cầu đăng nhập', text: 'Vui lòng đăng nhập để thêm vào giỏ hàng!' }).then(() => {
                                    window.location.href = '/Client/Account/Login';
                                });
                            });
                    })
                    .fail(function () {
                        Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Không thể lấy thông tin sản phẩm!' });
                    });
            });

            function escapeHtml(text) {
                if (!text && text !== 0) return '';
                return String(text).replace(/[&"'<>]/g, s => ({
                    '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;'
                }[s]));
            }
        });
    </script>
}

<!-- ✅ Modal chọn màu sắc và kích thước -->
<div class="modal fade" id="addToCartModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chọn màu sắc và kích thước</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formAddToCart">
                <div class="modal-body">
                    <div id="modalProductInfo" class="mb-3"></div>
                    <input type="hidden" id="modalMaSP" />

                    <div class="form-group">
                        <label class="font-weight-bold">Màu sắc: <span class="text-danger">*</span></label>
                        <select id="modalMauSac" class="form-control" required>
                            <option value="">-- Chọn màu sắc --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Kích thước: <span class="text-danger">*</span></label>
                        <select id="modalKichThuoc" class="form-control" required>
                            <option value="">-- Chọn kích thước --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Số lượng:</label>
                        <input type="number" id="modalSoLuong" class="form-control" value="1" min="1" required />
                        <small class="text-muted">Còn lại: <span id="modalSoLuongTon">-</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
@* them nut mua ngay *@
<!-- ✅ Modal chọn màu sắc và kích thước -->
<!-- ✅ Modal Mua Ngay -->
<div class="modal fade" id="buyNowModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chọn màu sắc và kích thước</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formBuyNow">
                <div class="modal-body">
                    <div id="buyNowProductInfo" class="mb-3"></div>
                    <input type="hidden" id="buyNowMaSP" />

                    <div class="form-group">
                        <label class="font-weight-bold">Màu sắc: <span class="text-danger">*</span></label>
                        <select id="buyNowMauSac" class="form-control" required>
                            <option value="">-- Chọn màu sắc --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Kích thước: <span class="text-danger">*</span></label>
                        <select id="buyNowKichThuoc" class="form-control" required>
                            <option value="">-- Chọn kích thước --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Số lượng:</label>
                        <input type="number" id="buyNowSoLuong" class="form-control" value="1" min="1" required />
                        <small class="text-muted">Còn lại: <span id="buyNowSoLuongTon">-</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                         Mua Ngay
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


