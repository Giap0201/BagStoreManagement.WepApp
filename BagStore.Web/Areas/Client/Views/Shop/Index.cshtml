@{
    Layout = "~/Areas/Client/Views/LayoutShop/_LayoutShopNew.cshtml";
    ViewData["Title"] = "Thanh toán";
}

<!-- 🔷 Page Header -->
<div class="container-fluid bg-secondary mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
        <h1 class="font-weight-semi-bold text-uppercase mb-3">Our Shop</h1>
        <div class="d-inline-flex">
            <p class="m-0"><a href="/">Home</a></p>
            <p class="m-0 px-2">-</p>
            <p class="m-0">Shop</p>
        </div>
    </div>
</div>

<!-- 🔷 Shop Content -->
<div class="container-fluid pt-5">
    <div class="row px-xl-5">
        <!-- 🧱 Sidebar Filters -->
        <div class="col-lg-3 col-md-12">
            <div class="border-bottom mb-4 pb-4">
                <h5 class="font-weight-semi-bold mb-4">Bộ lọc sản phẩm</h5>

                <div class="form-group mb-3">
                    <label for="filterLoaiTui" class="font-weight-bold small">Loại túi</label>
                    <select id="filterLoaiTui" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="filterThuongHieu" class="font-weight-bold small">Thương hiệu</label>
                    <select id="filterThuongHieu" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="filterChatLieu" class="font-weight-bold small">Chất liệu</label>
                    <select id="filterChatLieu" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 🧱 Product List -->
        <div class="col-lg-9 col-md-12">
            <div class="row pb-3">
                <!-- 🔍 Search -->
                <div class="col-12 pb-1 d-flex justify-content-between align-items-center mb-3">
                    <input id="searchTen" type="text" class="form-control w-50"
                        placeholder="Tìm theo tên sản phẩm..." />
                    <button id="btnSearch" class="btn btn-primary ml-2">Tìm</button>
                </div>

                <!-- 🛍️ Product container -->
                <div id="product-list" class="row w-100"></div>

                <!-- 🔸 Pagination -->
                <div class="col-12 pt-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-3" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        (function () {
            const apiUrl = '/api/SanPhamApi'; // ✅ Sử dụng action GetAll với query parameters
            let currentPage = 1;
            const pageSize = 9;

            $(document).ready(function () {
                // Initialize filters from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const loaiTuiId = urlParams.get('loaiTuiId') || urlParams.get('categoryId');
                const maThuongHieu = urlParams.get('maThuongHieu');
                const maChatLieu = urlParams.get('maChatLieu');

                loadFilters().then(() => {
                    // Set initial filter values from URL
                    if (loaiTuiId) $('#filterLoaiTui').val(loaiTuiId);
                    if (maThuongHieu) $('#filterThuongHieu').val(maThuongHieu);
                    if (maChatLieu) $('#filterChatLieu').val(maChatLieu);
                    loadSanPhams();
                });

                $('#btnSearch').on('click', () => {
                    currentPage = 1;
                    loadSanPhams();
                });

                $('#filterLoaiTui, #filterThuongHieu, #filterChatLieu').on('change', () => {
                    currentPage = 1;
                    loadSanPhams();
                });

                $(document).on('click', '#pagination a.page-link', function (e) {
                    e.preventDefault();
                    const page = parseInt($(this).data('page'));
                    if (!isNaN(page) && page > 0 && !$(this).parent().hasClass('disabled')) {
                        currentPage = page;
                        loadSanPhams();
                        // Scroll lên đầu trang sản phẩm
                        $('html, body').animate({
                            scrollTop: $('#product-list').offset().top - 100
                        }, 300);
                    }
                });
            });

            // 🔹 Load sản phẩm theo filter
            function loadSanPhams() {
                const keyword = $('#searchTen').val();
                const maLoaiTui = $('#filterLoaiTui').val() || null;
                const maThuongHieu = $('#filterThuongHieu').val() || null;
                const maChatLieu = $('#filterChatLieu').val() || null;

                $('#product-list').html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>');
                $('#pagination').empty();

                // Construct query parameters
                const params = new URLSearchParams({
                    page: currentPage,
                    pageSize: pageSize
                });

                if (keyword) params.append('search', keyword);
                if (maLoaiTui) params.append('maLoaiTui', maLoaiTui);
                if (maThuongHieu) params.append('maThuongHieu', maThuongHieu);
                if (maChatLieu) params.append('maChatLieu', maChatLieu);

                $.ajax({
                    url: `${apiUrl}?${params.toString()}`,
                    method: 'GET',
                    success: function (res) {
                        if (res && res.status === 'success' && res.data) {
                            const pagedResult = res.data;
                            // ✅ Format đúng: PageResult có Data, Total, Page, PageSize
                            const items = pagedResult.data || pagedResult.Data || [];
                            renderSanPhams(items);

                            // ✅ Render phân trang nếu có dữ liệu
                            const total = pagedResult.total || pagedResult.Total || 0;
                            const page = pagedResult.page || pagedResult.Page || 1;
                            const pageSize = pagedResult.pageSize || pagedResult.PageSize || 9;

                            if (total > 0) {
                                renderPagination(total, page, pageSize);
                            } else {
                                $('#pagination').empty();
                            }
                        } else {
                            $('#product-list').html('<div class="col-12 text-center py-5 text-muted">Không có sản phẩm nào.</div>');
                            $('#pagination').empty();
                        }
                    },
                    error: function (xhr) {
                        console.error('AJAX Error:', xhr);
                        $('#product-list').html('<div class="col-12 text-center py-5 text-danger">Không thể tải sản phẩm.</div>');
                    }
                });
            }

            // 🔹 Render danh sách sản phẩm
            function renderSanPhams(products) {
                if (!Array.isArray(products) || products.length === 0) {
                    $('#product-list').html('<div class="col-12 text-center py-5 text-muted">Không có sản phẩm nào.</div>');
                    return;
                }

                let html = '';
                products.forEach(sp => {
                    const imgUrl = sp.anhChinh
                        ? sp.anhChinh.replace(/^wwwroot/, '').replace(/^\/*/, '/')
                        : '/uploads/no-image.png';

                    html += `
                                                                                                <div class="col-lg-4 col-md-6 col-sm-12 pb-1">
                                                                                                    <div class="card product-item border-0 mb-4 shadow-sm">
                                                                                                        <div class="card-header product-img position-relative overflow-hidden bg-transparent border p-0">
                                                                                                            <img class="img-fluid w-100" src="${imgUrl}" alt="${escapeHtml(sp.tenSP)}">
                                                                                                        </div>
                                                                                                        <div class="card-body text-center p-3 border-left border-right">
                                                                                                            <h6 class="text-truncate mb-2">${escapeHtml(sp.tenSP)}</h6>
                                                                                                            <small class="text-muted d-block mb-1">${escapeHtml(sp.tenLoaiTui || '')}</small>
                                                                                                            <small class="text-muted">${escapeHtml(sp.tenThuongHieu || '')}</small>
                                                                                                        </div>
                                                                                                        <div class="card-footer d-flex justify-content-between bg-light border">
                                                                                                         <a href="/Client/Shop/Detail/${sp.maSP}" class="btn btn-sm text-dark p-0">
                                                                                                             <i class="fas fa-eye text-primary mr-1"></i>Chi tiết
                                                                                                         </a>
                                                                                                         <a href="#" class="btn btn-sm text-dark p-0 btn-add-to-cart" data-ma-sp="${sp.maSP}">
                                                                                                             <i class="fas fa-shopping-cart text-primary mr-1"></i>Thêm
                                                                                                         </a>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>`;
                });

                $('#product-list').html(html);
            }

            // 🔹 Render phân trang
            function renderPagination(totalItems, currentPageNum, pageSize) {
                const totalPages = Math.ceil(totalItems / pageSize);
                if (totalPages <= 1) {
                    $('#pagination').empty();
                    return;
                }

                let html = '';

                // Nút Previous
                html += `<li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
                                                <a class="page-link" href="#" data-page="${currentPageNum - 1}" ${currentPageNum === 1 ? 'onclick="return false;"' : ''}>&laquo;</a>
                                             </li>`;

                // Hiển thị số trang (tối đa 5 trang xung quanh trang hiện tại)
                let startPage = Math.max(1, currentPageNum - 2);
                let endPage = Math.min(totalPages, currentPageNum + 2);

                // Nếu ở đầu, hiển thị thêm trang cuối
                if (currentPageNum <= 3) {
                    endPage = Math.min(5, totalPages);
                }
                // Nếu ở cuối, hiển thị thêm trang đầu
                if (currentPageNum >= totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }

                // Trang đầu
                if (startPage > 1) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                    if (startPage > 2) {
                        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                // Các trang giữa
                for (let i = startPage; i <= endPage; i++) {
                    html += `<li class="page-item ${i === currentPageNum ? 'active' : ''}">
                                                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                                                 </li>`;
                }

                // Trang cuối
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
                }

                // Nút Next
                html += `<li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
                                                <a class="page-link" href="#" data-page="${currentPageNum + 1}" ${currentPageNum === totalPages ? 'onclick="return false;"' : ''}>&raquo;</a>
                                             </li>`;

                $('#pagination').html(html);
            }

            // 🔹 Escape HTML
            function escapeHtml(text) {
                if (!text && text !== 0) return '';
                return String(text).replace(/[&"'<>]/g, s => ({
                    '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;'
                }[s]));
            }

            // 🔹 Load các filter
            async function loadFilters() {
                try {
                    $('#filterLoaiTui, #filterThuongHieu, #filterChatLieu')
                        .prop('disabled', true)
                        .html('<option value="">Đang tải...</option>');

                    const [loai, thuongHieu, chatLieu] = await Promise.all([
                        $.get('/api/DanhMucLoaiTuiApi'),
                        $.get('/api/ThuongHieuApi'),
                        $.get('/api/ChatLieuApi')
                    ]);

                    if (loai.data) fillSelect("#filterLoaiTui", loai.data, "maLoaiTui", "tenLoaiTui");
                    if (thuongHieu.data) fillSelect("#filterThuongHieu", thuongHieu.data, "maThuongHieu", "tenThuongHieu");
                    if (chatLieu.data) fillSelect("#filterChatLieu", chatLieu.data, "maChatLieu", "tenChatLieu");
                } catch (err) {
                    console.error("Lỗi load filter:", err);
                    $('#filterLoaiTui, #filterThuongHieu, #filterChatLieu')
                        .html('<option value="">Lỗi tải dữ liệu</option>');
                } finally {
                    $('#filterLoaiTui, #filterThuongHieu, #filterChatLieu').prop('disabled', false);
                }
            }

            function fillSelect(selector, items, valueKey, textKey) {
                const $select = $(selector);
                $select.empty().append('<option value="">Tất cả</option>');

                if (!Array.isArray(items) || items.length === 0) {
                    $select.append('<option value="" disabled>Không có dữ liệu</option>');
                    return;
                }

                // Sort items alphabetically by text
                items.sort((a, b) => {
                    const textA = (a[textKey] || '').toString().toLowerCase();
                    const textB = (b[textKey] || '').toString().toLowerCase();
                    return textA.localeCompare(textB);
                });

                items.forEach(item => {
                    const value = item[valueKey];
                    const text = item[textKey];
                    if (value !== undefined && value !== null && text) {
                        $select.append(`<option value="${value}">${text}</option>`);
                    }
                });
            }
            // ✅ Xử lý button "Thêm vào giỏ"
            $(document).on('click', '.btn-add-to-cart', function (e) {
                e.preventDefault();
                const maSP = $(this).data('ma-sp');
                if (!maSP) return;

                openAddToCartModal(maSP);
            });

            // ✅ Hàm mở modal chọn màu/kích thước
            function openAddToCartModal(maSP) {
                // Hiển thị modal loading
                $('#addToCartModal').modal('show');
                $('#modalProductInfo').html('<div class="text-center py-3"><div class="spinner-border"></div></div>');
                $('#modalMauSac, #modalKichThuoc').empty().append('<option value="">Đang tải...</option>');

                // Load thông tin sản phẩm
                $.get('/Client/Shop/GetProductOptions', { maSP: maSP })
                    .done(function (data) {
                        // Hiển thị thông tin sản phẩm
                        const imgUrl = data.anhChinh ? data.anhChinh.replace(/^wwwroot/, '').replace(/\\/g, '/') : '/uploads/no-image.png';
                        $('#modalProductInfo').html(`
                                                                <div class="row align-items-center">
                                                                    <div class="col-3">
                                                                        <img src="${imgUrl}" class="img-fluid rounded" alt="${data.tenSP}" />
                                                                    </div>
                                                                    <div class="col-9">
                                                                        <h5>${escapeHtml(data.tenSP)}</h5>
                                                                        <p class="text-muted mb-0">Mã SP: ${data.maSP}</p>
                                                                    </div>
                                                                </div>
                                                            `);

                        // Load màu sắc
                        const $mauSac = $('#modalMauSac');
                        $mauSac.empty().append('<option value="">-- Chọn màu sắc --</option>');
                        if (data.mauSacs && data.mauSacs.length > 0) {
                            data.mauSacs.forEach(function (mau) {
                                $mauSac.append(`<option value="${mau.maMauSac || mau.MaMauSac}">${mau.tenMauSac || mau.TenMauSac}</option>`);
                            });
                        }

                        // Load kích thước
                        const $kichThuoc = $('#modalKichThuoc');
                        $kichThuoc.empty().append('<option value="">-- Chọn kích thước --</option>');
                        if (data.kichThuocs && data.kichThuocs.length > 0) {
                            data.kichThuocs.forEach(function (kt) {
                                $kichThuoc.append(`<option value="${kt.maKichThuoc || kt.MaKichThuoc}">${kt.tenKichThuoc || kt.TenKichThuoc}</option>`);
                            });
                        }

                        // Lưu maSP vào modal
                        $('#modalMaSP').val(maSP);
                    })
                    .fail(function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Không thể tải thông tin sản phẩm!',
                            confirmButtonText: 'OK'
                        });
                        $('#addToCartModal').modal('hide');
                    });
            }

            // ✅ Cập nhật số lượng tồn khi chọn màu/kích thước
            $('#modalMauSac, #modalKichThuoc').on('change', function () {
                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();

                if (!maSP || !maMauSac || !maKichThuoc) {
                    $('#modalSoLuongTon').text('-');
                    return;
                }

                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const soLuongTon = variant.soLuongTon || variant.SoLuongTon || 0;
                        $('#modalSoLuongTon').text(soLuongTon);
                        $('#modalSoLuong').attr('max', soLuongTon);
                    })
                    .fail(function () {
                        $('#modalSoLuongTon').text('-');
                    });
            });

            // ✅ Xử lý submit form thêm vào giỏ với thông báo swal
            $('#formAddToCart').on('submit', function (e) {
                e.preventDefault();

                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();
                const soLuong = parseInt($('#modalSoLuong').val()) || 1;

                if (!maMauSac || !maKichThuoc) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Thông báo',
                        text: 'Vui lòng chọn đầy đủ màu sắc và kích thước!',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return;
                }

                // Kiểm tra số lượng
                const soLuongTon = parseInt($('#modalSoLuongTon').text()) || 0;
                if (soLuong > soLuongTon) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Số lượng không đủ',
                        text: `Số lượng còn lại: ${soLuongTon}. Vui lòng chọn số lượng nhỏ hơn!`,
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Lấy MaChiTietSP
                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const maChiTietSP = variant.maChiTietSP || variant.MaChiTietSP;
                        if (!maChiTietSP) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Không tìm thấy biến thể sản phẩm này!',
                                confirmButtonText: 'OK'
                            });
                            return;
                        }

                        // Lấy MaKH từ user hiện tại (cần đăng nhập)
                        $.get('/Client/Shop/GetMaKH')
                            .done(function (response) {
                                if (!response || !response.maKH) {
                                    Swal.fire({
                                        icon: 'warning',
                                        title: 'Bạn chưa đăng nhập!',
                                        text: 'Vui lòng đăng nhập để thêm vào giỏ hàng!',
                                        confirmButtonText: 'Đăng nhập'
                                    }).then(() => {
                                        window.location.href = '/Client/Account/Login';
                                    });
                                    return;
                                }

                                // Gọi API thêm vào giỏ
                                $.ajax({
                                    url: '/api/Cart/add',
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        maKH: response.maKH,
                                        maChiTietSP: maChiTietSP,
                                        soLuong: soLuong
                                    }),
                                    success: function (result) {
                                        $('#addToCartModal').modal('hide');

                                        // Reset form
                                        $('#modalMauSac, #modalKichThuoc').val('');
                                        $('#modalSoLuong').val(1);
                                        $('#modalSoLuongTon').text('-');

                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Thành công!',
                                            text: 'Sản phẩm đã được thêm vào giỏ hàng',
                                            showConfirmButton: true,
                                            confirmButtonText: 'OK',
                                            timer: 2000,
                                            timerProgressBar: true
                                        });
                                    },
                                    error: function (xhr) {
                                        let errorMessage = 'Không thể thêm vào giỏ hàng!';

                                        if (xhr.status === 401) {
                                            Swal.fire({
                                                icon: 'warning',
                                                title: 'Yêu cầu đăng nhập',
                                                text: 'Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng',
                                                confirmButtonText: 'Đăng nhập',
                                                cancelButtonText: 'Hủy',
                                                showCancelButton: true
                                            }).then((result) => {
                                                if (result.isConfirmed) {
                                                    window.location.href = '/Client/Account/Login';
                                                }
                                            });
                                            return;
                                        } else if (xhr.status === 400) {
                                            errorMessage = xhr.responseJSON?.message || 'Dữ liệu không hợp lệ!';
                                        } else if (xhr.status === 404) {
                                            errorMessage = 'Không tìm thấy sản phẩm hoặc biến thể sản phẩm!';
                                        } else if (xhr.status === 500) {
                                            errorMessage = 'Lỗi hệ thống! Vui lòng thử lại sau.';
                                        } else if (xhr.responseJSON?.message) {
                                            errorMessage = xhr.responseJSON.message;
                                        }

                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Thất bại',
                                            text: errorMessage,
                                            confirmButtonText: 'Đã hiểu'
                                        });
                                    }
                                });
                            })
                            .fail(function () {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Bạn chưa đăng nhập!',
                                    text: 'Vui lòng đăng nhập để thêm vào giỏ hàng!',
                                    confirmButtonText: 'Đăng nhập'
                                }).then(() => {
                                    window.location.href = '/Client/Account/Login';
                                });
                            });
                    })
                    .fail(function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Không thể lấy thông tin sản phẩm!',
                            confirmButtonText: 'OK'
                        });
                    });
            });
        })();
    </script>
}

<!-- ✅ Modal chọn màu sắc và kích thước -->
<div class="modal fade" id="addToCartModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chọn màu sắc và kích thước</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formAddToCart">
                <div class="modal-body">
                    <div id="modalProductInfo" class="mb-3"></div>
                    <input type="hidden" id="modalMaSP" />

                    <div class="form-group">
                        <label class="font-weight-bold">Màu sắc: <span class="text-danger">*</span></label>
                        <select id="modalMauSac" class="form-control" required>
                            <option value="">-- Chọn màu sắc --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Kích thước: <span class="text-danger">*</span></label>
                        <select id="modalKichThuoc" class="form-control" required>
                            <option value="">-- Chọn kích thước --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Số lượng:</label>
                        <input type="number" id="modalSoLuong" class="form-control" value="1" min="1" required />
                        <small class="text-muted">Còn lại: <span id="modalSoLuongTon">-</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>