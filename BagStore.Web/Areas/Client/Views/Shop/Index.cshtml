@{
    Layout = "_LayoutBagStore";
    ViewData["Title"] = "Shop";
}

<!-- 🔷 Page Header -->
<div class="container-fluid bg-secondary mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
        <h1 class="font-weight-semi-bold text-uppercase mb-3">Our Shop</h1>
        <div class="d-inline-flex">
            <p class="m-0"><a href="/">Home</a></p>
            <p class="m-0 px-2">-</p>
            <p class="m-0">Shop</p>
        </div>
    </div>
</div>

<!-- 🔷 Shop Content -->
<div class="container-fluid pt-5">
    <div class="row px-xl-5">
        <!-- 🧱 Sidebar Filters -->
        <div class="col-lg-3 col-md-12">
            <div class="border-bottom mb-4 pb-4">
                <h5 class="font-weight-semi-bold mb-4">Bộ lọc sản phẩm</h5>

                <div class="form-group mb-3">
                    <label for="filterLoaiTui" class="font-weight-bold small">Loại túi</label>
                    <select id="filterLoaiTui" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="filterThuongHieu" class="font-weight-bold small">Thương hiệu</label>
                    <select id="filterThuongHieu" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="filterChatLieu" class="font-weight-bold small">Chất liệu</label>
                    <select id="filterChatLieu" class="form-control">
                        <option value="">Tất cả</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 🧱 Product List -->
        <div class="col-lg-9 col-md-12">
            <div class="row pb-3">
                <!-- 🔍 Search -->
                <div class="col-12 pb-1 d-flex justify-content-between align-items-center mb-3">
                    <input id="searchTen" type="text" class="form-control w-50" placeholder="Tìm theo tên sản phẩm..." />
                    <button id="btnSearch" class="btn btn-primary ml-2">Tìm</button>
                </div>

                <!-- 🛍️ Product container -->
                <div id="product-list" class="row w-100"></div>

                <!-- 🔸 Pagination -->
                <div class="col-12 pt-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-3" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const apiUrl = '/api/SanPhamApi/GetAllPaged'; // 🔧 khớp tên action
            let currentPage = 1;
            const pageSize = 9;

            $(document).ready(function () {
                loadFilters();
                loadSanPhams();

                $('#btnSearch').on('click', () => {
                    currentPage = 1;
                    loadSanPhams();
                });

                $('#filterLoaiTui, #filterThuongHieu, #filterChatLieu').on('change', () => {
                    currentPage = 1;
                    loadSanPhams();
                });

                $(document).on('click', '#pagination a.page-link', function (e) {
                    e.preventDefault();
                    const page = parseInt($(this).data('page'));
                    if (!isNaN(page) && page > 0) {
                        currentPage = page;
                        loadSanPhams();
                    }
                });
            });

            // 🔹 Load sản phẩm theo filter
            function loadSanPhams() {
                const keyword = $('#searchTen').val();
                const maLoaiTui = $('#filterLoaiTui').val();
                const maThuongHieu = $('#filterThuongHieu').val();
                const maChatLieu = $('#filterChatLieu').val();

                $('#product-list').html('<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>');
                $('#pagination').empty();

                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    data: {
                        page: currentPage,
                        pageSize: pageSize,
                        keyword: keyword,
                        maLoaiTui: maLoaiTui,
                        maThuongHieu: maThuongHieu,
                        maChatLieu: maChatLieu
                    },
                    success: function (res) {
                        if (res && res.status === 'success' && res.data) {
                            const data = res.data;
                            const items = data.items || [];
                            renderSanPhams(items);
                            if (data.totalItems > 0)
                                renderPagination(data.totalItems, data.page, data.pageSize);
                        } else {
                            $('#product-list').html('<div class="col-12 text-center py-5 text-muted">Không có sản phẩm nào.</div>');
                        }
                    },
                    error: function (xhr) {
                        console.error('AJAX Error:', xhr);
                        $('#product-list').html('<div class="col-12 text-center py-5 text-danger">Không thể tải sản phẩm.</div>');
                    }
                });
            }

            // 🔹 Render danh sách sản phẩm
            function renderSanPhams(products) {
                if (!Array.isArray(products) || products.length === 0) {
                    $('#product-list').html('<div class="col-12 text-center py-5 text-muted">Không có sản phẩm nào.</div>');
                    return;
                }

                let html = '';
                products.forEach(sp => {
                    const imgUrl = sp.anhChinh
                        ? sp.anhChinh.replace(/^wwwroot/, '').replace(/^\/*/, '/')
                        : '/uploads/no-image.png';

                    html += `
                        <div class="col-lg-4 col-md-6 col-sm-12 pb-1">
                            <div class="card product-item border-0 mb-4 shadow-sm">
                                <div class="card-header product-img position-relative overflow-hidden bg-transparent border p-0">
                                    <img class="img-fluid w-100" src="${imgUrl}" alt="${escapeHtml(sp.tenSP)}">
                                </div>
                                <div class="card-body text-center p-3 border-left border-right">
                                    <h6 class="text-truncate mb-2">${escapeHtml(sp.tenSP)}</h6>
                                    <small class="text-muted d-block mb-1">${escapeHtml(sp.tenLoaiTui || '')}</small>
                                    <small class="text-muted">${escapeHtml(sp.tenThuongHieu || '')}</small>
                                </div>
                                <div class="card-footer d-flex justify-content-between bg-light border">
                                    <a href="/Client/Shop/Detail/${sp.maSP}" class="btn btn-sm text-dark p-0">
                                        <i class="fas fa-eye text-primary mr-1"></i>Chi tiết
                                    </a>
                                    <a href="#" class="btn btn-sm text-dark p-0">
                                        <i class="fas fa-shopping-cart text-primary mr-1"></i>Thêm
                                    </a>
                                </div>
                            </div>
                        </div>`;
                });

                $('#product-list').html(html);
            }

            // 🔹 Render phân trang
            function renderPagination(totalItems, currentPage, pageSize) {
                const totalPages = Math.ceil(totalItems / pageSize);
                if (totalPages <= 1) return;

                let html = `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a>
                    </li>`;

                for (let i = 1; i <= totalPages; i++) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>`;
                }

                html += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a>
                    </li>`;

                $('#pagination').html(html);
            }

            // 🔹 Escape HTML
            function escapeHtml(text) {
                if (!text && text !== 0) return '';
                return String(text).replace(/[&"'<>]/g, s => ({
                    '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;'
                }[s]));
            }

            // 🔹 Load các filter
            async function loadFilters() {
                try {
                    const [loai, thuongHieu, chatLieu] = await Promise.all([
                        $.get('/api/DanhMucLoaiTuiApi'),
                        $.get('/api/ThuongHieuApi'),
                        $.get('/api/ChatLieuApi')
                    ]);
                    fillSelect("#filterLoaiTui", loai.data, "maLoaiTui", "tenLoaiTui");
                    fillSelect("#filterThuongHieu", thuongHieu.data, "maThuongHieu", "tenThuongHieu");
                    fillSelect("#filterChatLieu", chatLieu.data, "maChatLieu", "tenChatLieu");
                } catch (err) {
                    console.error("Lỗi load filter:", err);
                }
            }

            function fillSelect(selector, items, valueKey, textKey) {
                const $select = $(selector);
                $select.empty().append('<option value="">Tất cả</option>');
                if (!Array.isArray(items)) return;
                items.forEach(i => {
                    $select.append(`<option value="${i[valueKey]}">${i[textKey]}</option>`);
                });
            }
        })();
    </script>
}
