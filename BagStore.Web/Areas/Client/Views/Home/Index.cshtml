@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = "~/Areas/Client/Views/LayoutShop/_LayoutShopNew.cshtml";
}

<!-- 🔷 Home Hero Section with CTA -->




<!-- 🔷 Danh sách sản phẩm -->
<div class="container-fluid pt-5">
    <div class="text-center mb-4">
        <h2 class="section-title px-5"><span class="px-2">Sản phẩm mới nhất</span></h2>
        <p class="text-muted mt-1 mb-0">Khám phá bộ sưu tập túi xách thời thượng vừa cập nhật!</p>
    </div>

    <div class="row px-xl-5">
        @if (Model != null && Model.Any())
        {
            foreach (var sp in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 pb-1">
                    <div class="card product-item border-0 mb-4 shadow-sm">
                        <div class="card-header product-img position-relative overflow-hidden bg-transparent border p-0">
                            <img class="img-fluid w-100"
                                src="@(string.IsNullOrEmpty(sp.AnhChinh) ? "/img/no-image.png" : sp.AnhChinh)"
                                alt="@sp.TenSP" />
                        </div>
                        <div class="card-body text-center p-3 border-left border-right">
                            <h6 class="text-truncate mb-2">@sp.TenSP</h6>
                            <small class="text-muted d-block mb-1">@sp.TenThuongHieu</small>
                            <small class="text-muted">@sp.TenChatLieu</small>
                        </div>
                        <div class="card-footer d-flex justify-content-between bg-light border">
                            <a href="/Client/Shop/Detail/@sp.MaSP" class="btn btn-sm text-dark p-0">
                                <i class="fas fa-eye text-primary mr-1"></i>Chi tiết
                            </a>
                            <a href="#" class="btn btn-sm text-dark p-0 btn-add-to-cart" data-ma-sp="@sp.MaSP">
                                <i class="fas fa-shopping-cart text-primary mr-1"></i>Thêm
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center text-muted py-5">Không có sản phẩm nào để hiển thị.</div>
        }
    </div>
</div>

<section class="container-fluid px-0 mb-5"
         style="background: linear-gradient(90deg, #D19C97 60%, #fff 100%); position: relative;">
    <div class="row align-items-center" style="min-height: 350px;">
        <div class="col-lg-6 text-center text-lg-left px-5 py-4">
            <h2 class="display-4 font-weight-bold mb-3 text-dark" style="line-height: 1.1;">
                Khám phá những mẫu túi xách thời trang mới nhất
            </h2>
            <p class="lead text-secondary mb-4">
                Sản phẩm chất lượng, mẫu mã đa dạng, giá cả hợp lý.<br />
                BagStore - nơi phong cách bắt đầu cho bạn!
            </p>
            <a href="/Client/Shop" class="btn btn-primary btn-lg px-4 rounded-pill shadow-sm font-weight-bold">
                Mua ngay
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
        <div class="col-lg-6 d-none d-lg-flex justify-content-end align-items-center h-100 pr-5">
            <img src="/img/banner-bagstore.png" alt="Banner BagStore"
                 style="max-width: 340px; width:100%; border-radius: 2.5rem; box-shadow: 0 6px 40px rgba(0,0,0,0.13);"
                 onerror="this.onerror=null;this.src='/img/no-image.png';" />
        </div>
    </div>

</section>
<!-- 🔷 Why Choose Us - Feature Highlights -->
<section class="container mb-4">
    <div class="row justify-content-center text-center">
        <div class="col-6 col-md-3 mb-3 mb-md-0">
            <div class="py-3 px-2 bg-light rounded shadow-sm h-100">
                <i class="fas fa-shipping-fast fa-2x text-primary mb-2"></i>
                <h6 class="mb-1 font-weight-bold">Giao hàng nhanh</h6>
                <small>Miễn phí toàn quốc với đơn từ 500K</small>
            </div>
        </div>
        <div class="col-6 col-md-3 mb-3 mb-md-0">
            <div class="py-3 px-2 bg-light rounded shadow-sm h-100">
                <i class="fas fa-undo-alt fa-2x text-primary mb-2"></i>
                <h6 class="mb-1 font-weight-bold">Đổi trả dễ dàng</h6>
                <small>Đổi trả trong 7 ngày với lỗi sản phẩm</small>
            </div>
        </div>
        <div class="col-6 col-md-3 mb-3 mb-md-0">
            <div class="py-3 px-2 bg-light rounded shadow-sm h-100">
                <i class="fas fa-lock fa-2x text-primary mb-2"></i>
                <h6 class="mb-1 font-weight-bold">Thanh toán an toàn</h6>
                <small>Bảo mật tuyệt đối mọi giao dịch</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="py-3 px-2 bg-light rounded shadow-sm h-100">
                <i class="fas fa-headset fa-2x text-primary mb-2"></i>
                <h6 class="mb-1 font-weight-bold">Hỗ trợ 24/7</h6>
                <small>Tư vấn & giải đáp mọi thắc mắc của bạn</small>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            // ✅ Xử lý button "Thêm vào giỏ"
            $('.btn-add-to-cart').on('click', function (e) {
                e.preventDefault();
                const maSP = $(this).data('ma-sp');
                if (!maSP) return;

                openAddToCartModal(maSP);
            });

            // ✅ Hàm mở modal chọn màu/kích thước
            function openAddToCartModal(maSP) {
                // Hiển thị modal loading
                const modalElement = document.getElementById('addToCartModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                $('#modalProductInfo').html('<div class="text-center py-3"><div class="spinner-border"></div></div>');
                $('#modalMauSac, #modalKichThuoc').empty().append('<option value="">Đang tải...</option>');

                // Load thông tin sản phẩm
                $.get('/Client/Shop/GetProductOptions', { maSP: maSP })
                    .done(function (data) {
                        // Hiển thị thông tin sản phẩm
                        const imgUrl = data.anhChinh ? data.anhChinh.replace(/^wwwroot/, '').replace(/\\/g, '/') : '/uploads/no-image.png';
                        $('#modalProductInfo').html(`
                                            <div class="row align-items-center">
                                                <div class="col-3">
                                                    <img src="${imgUrl}" class="img-fluid rounded" alt="${data.tenSP}" />
                                                </div>
                                                <div class="col-9">
                                                    <h5>${escapeHtml(data.tenSP)}</h5>
                                                    <p class="text-muted mb-0">Mã SP: ${data.maSP}</p>
                                                </div>
                                            </div>
                                        `);

                        // Load màu sắc
                        const $mauSac = $('#modalMauSac');
                        $mauSac.empty().append('<option value="">-- Chọn màu sắc --</option>');
                        if (data.mauSacs && data.mauSacs.length > 0) {
                            data.mauSacs.forEach(function (mau) {
                                $mauSac.append(`<option value="${mau.maMauSac || mau.MaMauSac}">${mau.tenMauSac || mau.TenMauSac}</option>`);
                            });
                        }

                        // Load kích thước
                        const $kichThuoc = $('#modalKichThuoc');
                        $kichThuoc.empty().append('<option value="">-- Chọn kích thước --</option>');
                        if (data.kichThuocs && data.kichThuocs.length > 0) {
                            data.kichThuocs.forEach(function (kt) {
                                $kichThuoc.append(`<option value="${kt.maKichThuoc || kt.MaKichThuoc}">${kt.tenKichThuoc || kt.TenKichThuoc}</option>`);
                            });
                        }

                        // Lưu maSP vào modal
                        $('#modalMaSP').val(maSP);
                    })
                    .fail(function () {
                        alert('Không thể tải thông tin sản phẩm!');
                        const modalElement = document.getElementById('addToCartModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) modal.hide();
                    });
            }

            // ✅ Cập nhật số lượng tồn khi chọn màu/kích thước
            $('#modalMauSac, #modalKichThuoc').on('change', function () {
                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();

                if (!maSP || !maMauSac || !maKichThuoc) {
                    $('#modalSoLuongTon').text('-');
                    return;
                }

                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const soLuongTon = variant.soLuongTon || variant.SoLuongTon || 0;
                        $('#modalSoLuongTon').text(soLuongTon);
                        $('#modalSoLuong').attr('max', soLuongTon);
                    })
                    .fail(function () {
                        $('#modalSoLuongTon').text('-');
                    });
            });

            // ✅ Xử lý submit form thêm vào giỏ
            $('#formAddToCart').on('submit', function (e) {
                e.preventDefault();

                const maSP = $('#modalMaSP').val();
                const maMauSac = $('#modalMauSac').val();
                const maKichThuoc = $('#modalKichThuoc').val();
                const soLuong = parseInt($('#modalSoLuong').val()) || 1;

                if (!maMauSac || !maKichThuoc) {
                    alert('Vui lòng chọn màu sắc và kích thước!');
                    return;
                }

                // Lấy MaChiTietSP
                $.get('/Client/Shop/GetVariant', {
                    maSp: maSP,
                    colorId: maMauSac,
                    sizeId: maKichThuoc
                })
                    .done(function (variant) {
                        const maChiTietSP = variant.maChiTietSP || variant.MaChiTietSP;
                        if (!maChiTietSP) {
                            alert('Không tìm thấy biến thể sản phẩm này!');
                            return;
                        }

                        // Lấy MaKH từ user hiện tại (cần đăng nhập)
                        $.get('/Client/Shop/GetMaKH')
                            .done(function (response) {
                                if (!response || !response.maKH) {
                                    alert('Vui lòng đăng nhập để thêm vào giỏ hàng!');
                                    window.location.href = '/Client/Account/Login';
                                    return;
                                }

                                // Gọi API thêm vào giỏ
                                $.ajax({
                                    url: '/api/Cart/add',
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({
                                        maKH: response.maKH,
                                        maChiTietSP: maChiTietSP,
                                        soLuong: soLuong
                                    }),
                                    success: function (result) {
                                        alert('Đã thêm vào giỏ hàng thành công!');
                                        const modalElement = document.getElementById('addToCartModal');
                                        const modal = bootstrap.Modal.getInstance(modalElement);
                                        if (modal) modal.hide();
                                    },
                                    error: function (xhr) {
                                        if (xhr.status === 401) {
                                            alert('Vui lòng đăng nhập để thêm vào giỏ hàng!');
                                            window.location.href = '/Client/Account/Login';
                                        } else {
                                            alert(xhr.responseJSON?.message || 'Không thể thêm vào giỏ hàng!');
                                        }
                                    }
                                });
                            })
                            .fail(function () {
                                alert('Vui lòng đăng nhập để thêm vào giỏ hàng!');
                                window.location.href = '/Client/Account/Login';
                            });
                    })
                    .fail(function () {
                        alert('Không thể lấy thông tin sản phẩm!');
                    });
            });

            function escapeHtml(text) {
                if (!text && text !== 0) return '';
                return String(text).replace(/[&"'<>]/g, s => ({
                    '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;'
                }[s]));
            }
        });
    </script>
}

<!-- ✅ Modal chọn màu sắc và kích thước -->
<div class="modal fade" id="addToCartModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chọn màu sắc và kích thước</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form id="formAddToCart">
                <div class="modal-body">
                    <div id="modalProductInfo" class="mb-3"></div>
                    <input type="hidden" id="modalMaSP" />

                    <div class="form-group">
                        <label class="font-weight-bold">Màu sắc: <span class="text-danger">*</span></label>
                        <select id="modalMauSac" class="form-control" required>
                            <option value="">-- Chọn màu sắc --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Kích thước: <span class="text-danger">*</span></label>
                        <select id="modalKichThuoc" class="form-control" required>
                            <option value="">-- Chọn kích thước --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Số lượng:</label>
                        <input type="number" id="modalSoLuong" class="form-control" value="1" min="1" required />
                        <small class="text-muted">Còn lại: <span id="modalSoLuongTon">-</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
